---
- name: Write secrets and config to temp files
  ansible.builtin.copy:
    content: "{{ item.content }}"
    dest: "{{ item.dest }}"
    mode: "0600"
  no_log: true
  loop:
    - content: "{{ gateway_token }}"
      dest: /tmp/ansible-gateway-token
    - content: "{{ xai_api_key | default('') }}"
      dest: /tmp/ansible-xai-api-key
    - content: "{{ openclaw_custom_models | to_json }}"
      dest: /tmp/ansible-custom-models
    - content: "{{ openclaw_model_fallbacks | to_json }}"
      dest: /tmp/ansible-model-fallbacks

- name: Configure gateway with secret cleanup
  block:
    - name: Configure gateway secrets (auth tokens, API keys)
      ansible.builtin.shell: |
        set -euo pipefail
        GATEWAY_TOKEN=$(cat /tmp/ansible-gateway-token)
        XAI_API_KEY=$(cat /tmp/ansible-xai-api-key)

        # Auth: token mode
        openclaw config set gateway.auth.mode token
        openclaw config set gateway.auth.token "$GATEWAY_TOKEN"
        openclaw config set gateway.remote.token "$GATEWAY_TOKEN"

        # Web search (Grok / xAI)
        {% if xai_api_key is defined and xai_api_key | length > 0 %}
        if [ -z "$XAI_API_KEY" ]; then
            echo "ERROR: xAI API key template was non-empty but runtime value is empty"
            exit 1
        fi
        # Set new Grok provider FIRST
        openclaw config set tools.web.search.provider grok
        openclaw config set tools.web.search.grok.apiKey "$XAI_API_KEY"
        openclaw config set tools.web.search.timeoutSeconds 60
        # Clean up old Brave config path (idempotent for fresh installs)
        openclaw config unset tools.web.search.apiKey 2>/dev/null || true
        {% else %}
        for key in tools.web.search.provider tools.web.search.apiKey tools.web.search.grok.apiKey tools.web.search.timeoutSeconds; do
            output=$(openclaw config unset "$key" 2>&1) || {
                if echo "$output" | grep -qi "not set\|not found\|does not exist"; then
                    true
                else
                    echo "ERROR: Failed to unset $key: $output"
                    exit 1
                fi
            }
        done
        {% endif %}
      args:
        executable: /bin/bash
      no_log: true
      notify: restart openclaw-gateway

    - name: Configure gateway settings
      ansible.builtin.shell: |
        set -euo pipefail

        # Tailscale Serve
        openclaw config set gateway.tailscale.mode serve
        openclaw config set gateway.tailscale.resetOnExit true

        # Trusted proxies: localhost + Tailscale CGNAT range
        openclaw config set gateway.trustedProxies '["127.0.0.1", "100.64.0.0/10"]'

        # Control UI
        openclaw config set gateway.controlUi.enabled true
        openclaw config set gateway.controlUi.allowInsecureAuth false

        # Auth: Tailscale identity
        openclaw config set gateway.auth.allowTailscale true

        # Model defaults
        openclaw config set agents.defaults.model.primary "{{ openclaw_model_primary }}"
        openclaw config set agents.defaults.model.fallbacks --json "$(cat /tmp/ansible-model-fallbacks)"
        openclaw config set agents.defaults.thinkingDefault {{ openclaw_thinking_default }}

        # Custom model definitions
        openclaw config set models --json "$(cat /tmp/ansible-custom-models)"

        # Sandbox tool allowlist (all groups + plugins)
        {% set tool_allow = ["group:openclaw","group:runtime","group:fs","group:sessions","group:memory","group:web","group:ui","group:automation","group:messaging","group:nodes"] %}
        {% if openclaw_mcp_adapter is defined %}
        {%   set _ = tool_allow.append("openclaw-mcp-adapter") %}
        {% endif %}
        openclaw config set tools.sandbox.tools.allow --json '{{ tool_allow | to_json }}'

        # Elevated tools (allow Telegram users to approve sensitive actions)
        openclaw config set tools.elevated.enabled true
        {% set elevated_users = [] %}
        {% if telegram_user_id is defined and telegram_user_id | length > 0 %}
        {%   set _ = elevated_users.append(telegram_user_id | int) %}
        {% endif %}
        {% if telegram_manon_user_id is defined and telegram_manon_user_id | length > 0 %}
        {%   set _ = elevated_users.append(telegram_manon_user_id | int) %}
        {% endif %}
        {% if elevated_users | length > 0 %}
        openclaw config set tools.elevated.allowFrom.telegram --json '{{ elevated_users | to_json }}'
        {% endif %}

        # Elevated default
        openclaw config set agents.defaults.elevatedDefault {{ openclaw_elevated_default }}

        # Timezone
        openclaw config set agents.defaults.userTimezone "{{ openclaw_timezone }}"
        openclaw config set agents.defaults.envelopeTimezone user

        # Heartbeat interval
        openclaw config set agents.defaults.heartbeat.every {{ openclaw_heartbeat_interval }}

        # Sandbox configuration
        openclaw config set agents.defaults.sandbox.mode {{ openclaw_sandbox_mode }}
        openclaw config set agents.defaults.sandbox.workspaceAccess {{ openclaw_sandbox_workspace_access }}
        openclaw config set agents.defaults.sandbox.docker.network {{ openclaw_sandbox_docker_network }}
        openclaw config set agents.defaults.sandbox.docker.image "{{ openclaw_sandbox_docker_image }}"
        openclaw config set agents.defaults.sandbox.docker.readOnlyRoot --json '{{ openclaw_sandbox_read_only_root | to_json }}'
      args:
        executable: /bin/bash
      notify: restart openclaw-gateway

    - name: Remove stale sandbox containers after config change
      ansible.builtin.shell: |
        set -euo pipefail
        containers=$(docker ps -q --filter "name=openclaw-sbx-" 2>/dev/null || true)
        if [ -n "$containers" ]; then
          count=$(echo "$containers" | wc -l)
          echo "Removing $count sandbox container(s) to apply new Docker flags"
          echo "$containers" | xargs docker rm -f
        else
          echo "No running sandbox containers to remove"
        fi
      args:
        executable: /bin/bash
      register: sandbox_container_removal
      changed_when: sandbox_container_removal.stdout is search('Removing')
      notify: restart openclaw-gateway

  always:
    - name: Clean up secret temp files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/ansible-gateway-token
        - /tmp/ansible-xai-api-key
        - /tmp/ansible-custom-models
        - /tmp/ansible-model-fallbacks
