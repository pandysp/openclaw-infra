---
- name: Write secrets to temp files
  ansible.builtin.copy:
    content: "{{ item.content }}"
    dest: "{{ item.dest }}"
    mode: "0600"
  no_log: true
  loop:
    - { content: "{{ gateway_token }}", dest: /tmp/ansible-gateway-token }
    - { content: "{{ brave_api_key | default('') }}", dest: /tmp/ansible-brave-api-key }

- name: Configure gateway with secret cleanup
  block:
    - name: Configure OpenClaw gateway
      ansible.builtin.shell: |
        set -euo pipefail
        GATEWAY_TOKEN=$(cat /tmp/ansible-gateway-token)
        BRAVE_API_KEY=$(cat /tmp/ansible-brave-api-key)

        # Tailscale Serve
        openclaw config set gateway.tailscale.mode serve
        openclaw config set gateway.tailscale.resetOnExit true

        # Trusted proxies: localhost + Tailscale CGNAT range
        openclaw config set gateway.trustedProxies '["127.0.0.1", "100.64.0.0/10"]'

        # Control UI
        openclaw config set gateway.controlUi.enabled true
        openclaw config set gateway.controlUi.allowInsecureAuth false

        # Auth: token mode + Tailscale identity
        openclaw config set gateway.auth.mode token
        openclaw config set gateway.auth.token "$GATEWAY_TOKEN"
        openclaw config set gateway.auth.allowTailscale true
        openclaw config set gateway.remote.token "$GATEWAY_TOKEN"

        # Model defaults
        openclaw config set agents.defaults.model.primary "{{ openclaw_model_primary }}"
        openclaw config set agents.defaults.thinkingDefault {{ openclaw_thinking_default }}

        # Sandbox tool allowlist (all groups)
        openclaw config set tools.sandbox.tools.allow --json '["group:openclaw","group:runtime","group:fs","group:sessions","group:memory","group:web","group:ui","group:automation","group:messaging","group:nodes"]'

        # Elevated tools (allow Telegram user to approve sensitive actions)
        openclaw config set tools.elevated.enabled true
        {% if telegram_user_id is defined and telegram_user_id | length > 0 %}
        openclaw config set tools.elevated.allowFrom.telegram --json '[{{ telegram_user_id }}]'
        {% endif %}

        # Web search (Brave)
        {% if brave_api_key is defined and brave_api_key | length > 0 %}
        if [ -z "$BRAVE_API_KEY" ]; then
            echo "ERROR: Brave API key template was non-empty but runtime value is empty"
            exit 1
        fi
        openclaw config set tools.web.search.provider brave
        openclaw config set tools.web.search.apiKey "$BRAVE_API_KEY"
        {% else %}
        for key in tools.web.search.provider tools.web.search.apiKey; do
            output=$(openclaw config unset "$key" 2>&1) || {
                if echo "$output" | grep -qi "not set\|not found\|does not exist"; then
                    true
                else
                    echo "ERROR: Failed to unset $key: $output"
                    exit 1
                fi
            }
        done
        {% endif %}

        # Elevated default
        openclaw config set agents.defaults.elevatedDefault {{ openclaw_elevated_default }}

        # Sandbox configuration
        openclaw config set agents.defaults.sandbox.mode {{ openclaw_sandbox_mode }}
        openclaw config set agents.defaults.sandbox.workspaceAccess {{ openclaw_sandbox_workspace_access }}
        openclaw config set agents.defaults.sandbox.docker.network {{ openclaw_sandbox_docker_network }}
        openclaw config set agents.defaults.sandbox.docker.image "{{ openclaw_sandbox_docker_image }}"
      args:
        executable: /bin/bash
      no_log: true
      notify: restart openclaw-gateway

  always:
    - name: Clean up secret temp files
      ansible.builtin.file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/ansible-gateway-token
        - /tmp/ansible-brave-api-key
