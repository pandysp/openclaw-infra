---
- name: Validate provider is set and supported
  ansible.builtin.assert:
    that:
      - provider is defined
      - provider in openclaw_provider_defaults
    fail_msg: >-
      Invalid or missing provider '{{ provider | default("UNDEFINED") }}'.
      Supported providers: {{ openclaw_provider_defaults.keys() | list | join(', ') }}.
      Set via: pulumi config set provider claude

- name: Compute effective model configuration
  ansible.builtin.set_fact:
    effective_model_primary: "{{ openclaw_model_primary if openclaw_model_primary | length > 0 else openclaw_provider_defaults[provider].model_primary }}"
    effective_thinking_default: "{{ openclaw_thinking_default if openclaw_thinking_default | length > 0 else openclaw_provider_defaults[provider].thinking_default }}"

- name: Write gateway token to temp file
  ansible.builtin.copy:
    content: "{{ gateway_token }}"
    dest: /tmp/ansible-gateway-token
    mode: "0600"
  no_log: true

- name: Configure OpenClaw gateway
  ansible.builtin.shell: |
    set -euo pipefail
    GATEWAY_TOKEN=$(cat /tmp/ansible-gateway-token)

    # Tailscale Serve
    openclaw config set gateway.tailscale.mode serve
    openclaw config set gateway.tailscale.resetOnExit true

    # Trusted proxies: localhost + Tailscale CGNAT range
    openclaw config set gateway.trustedProxies '["127.0.0.1", "100.64.0.0/10"]'

    # Control UI
    openclaw config set gateway.controlUi.enabled true
    openclaw config set gateway.controlUi.allowInsecureAuth false

    # Auth: token mode + Tailscale identity
    openclaw config set gateway.auth.mode token
    openclaw config set gateway.auth.token "$GATEWAY_TOKEN"
    openclaw config set gateway.auth.allowTailscale true
    openclaw config set gateway.remote.token "$GATEWAY_TOKEN"

    # Model defaults (provider: {{ provider }})
    openclaw config set agents.defaults.model.primary "{{ effective_model_primary }}"
    openclaw config set agents.defaults.thinkingDefault {{ effective_thinking_default }}

    # Sandbox tool allowlist (all groups)
    openclaw config set tools.sandbox.tools.allow --json '["group:openclaw","group:runtime","group:fs","group:sessions","group:memory","group:web","group:ui","group:automation","group:messaging","group:nodes"]'

    # Elevated tools (allow Telegram user to approve sensitive actions)
    openclaw config set tools.elevated.enabled true
    {% if telegram_user_id is defined and telegram_user_id | length > 0 %}
    openclaw config set tools.elevated.allowFrom.telegram --json '[{{ telegram_user_id }}]'
    {% endif %}

    # Sandbox configuration
    openclaw config set agents.defaults.sandbox.mode {{ openclaw_sandbox_mode }}
    openclaw config set agents.defaults.sandbox.workspaceAccess {{ openclaw_sandbox_workspace_access }}
    openclaw config set agents.defaults.sandbox.docker.network {{ openclaw_sandbox_docker_network }}
    openclaw config set agents.defaults.sandbox.docker.image "{{ openclaw_sandbox_docker_image }}"
  args:
    executable: /bin/bash
  no_log: true
  notify: restart openclaw-gateway

- name: Write API token to temp file for Kimi config
  ansible.builtin.copy:
    content: "{{ api_token }}"
    dest: /tmp/ansible-api-token
    mode: "0600"
  no_log: true
  when: provider == "kimi"

- name: Set Kimi API key in OpenClaw env (Kimi provider only)
  ansible.builtin.shell: |
    set -euo pipefail
    KIMI_KEY=$(cat /tmp/ansible-api-token)
    openclaw config set env.KIMI_API_KEY "$KIMI_KEY"
  args:
    executable: /bin/bash
  no_log: true
  when: provider == "kimi"
  notify: restart openclaw-gateway

- name: Clean up API token temp file
  ansible.builtin.file:
    path: /tmp/ansible-api-token
    state: absent
  when: provider == "kimi"

- name: Remove Kimi API key from OpenClaw env (non-Kimi provider)
  ansible.builtin.shell: |
    set -euo pipefail
    output=$(openclaw config unset env.KIMI_API_KEY 2>&1) || {
        if echo "$output" | grep -qi "not set\|not found\|does not exist"; then
            true
        else
            echo "ERROR: Failed to unset env.KIMI_API_KEY: $output"
            exit 1
        fi
    }
  args:
    executable: /bin/bash
  when: provider != "kimi"
  notify: restart openclaw-gateway

- name: Clean up gateway token
  ansible.builtin.file:
    path: /tmp/ansible-gateway-token
    state: absent
