---
- name: Check if base sandbox image exists
  ansible.builtin.command: docker image inspect openclaw-sandbox:trixie
  register: base_image_check
  changed_when: false
  failed_when: false

- name: Create sandbox build directory
  ansible.builtin.file:
    path: /home/ubuntu/.openclaw/sandbox-build
    state: directory
    mode: "0755"

- name: Template base sandbox Dockerfile
  ansible.builtin.template:
    src: Dockerfile.base.j2
    dest: /home/ubuntu/.openclaw/sandbox-build/Dockerfile.base
    mode: "0644"
  register: base_dockerfile_changed

- name: Build base sandbox image
  ansible.builtin.shell: |
    docker build -t openclaw-sandbox:trixie -f /home/ubuntu/.openclaw/sandbox-build/Dockerfile.base /home/ubuntu/.openclaw/sandbox-build/
  args:
    executable: /bin/bash
  when: base_image_check.rc != 0 or base_dockerfile_changed.changed or (force_sandbox_rebuild | bool)

- name: Verify base sandbox image was built
  ansible.builtin.command: docker image inspect openclaw-sandbox:trixie
  changed_when: false

- name: Template custom sandbox Dockerfile
  ansible.builtin.template:
    src: Dockerfile.sandbox.j2
    dest: /home/ubuntu/.openclaw/sandbox-build/Dockerfile
    mode: "0644"
  register: dockerfile_changed

- name: Check if custom sandbox image exists
  ansible.builtin.command: docker image inspect openclaw-sandbox-custom:latest
  register: custom_image_check
  changed_when: false
  failed_when: false

- name: Build custom sandbox Docker image
  ansible.builtin.shell: |
    docker build -t openclaw-sandbox-custom:latest /home/ubuntu/.openclaw/sandbox-build/
  args:
    executable: /bin/bash
  when: force_sandbox_rebuild | bool or dockerfile_changed.changed or base_dockerfile_changed.changed or custom_image_check.rc != 0

- name: Verify custom sandbox image was built
  ansible.builtin.command: docker image inspect openclaw-sandbox-custom:latest
  changed_when: false
