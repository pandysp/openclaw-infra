---
- name: Check if base sandbox image exists
  ansible.builtin.command: docker image inspect openclaw-sandbox:bookworm-slim
  register: base_image_check
  changed_when: false
  failed_when: false

- name: Pull base sandbox image via openclaw doctor --fix
  ansible.builtin.shell: |
    export XDG_RUNTIME_DIR=/run/user/1000
    openclaw doctor --fix || true
  args:
    executable: /bin/bash
  when: base_image_check.rc != 0

- name: Wait for base image to be available
  ansible.builtin.command: docker image inspect openclaw-sandbox:bookworm-slim
  register: base_image_verify
  retries: 3
  delay: 10
  until: base_image_verify.rc == 0
  changed_when: false
  when: base_image_check.rc != 0

- name: Create sandbox build directory
  ansible.builtin.file:
    path: /home/ubuntu/.openclaw/sandbox-build
    state: directory
    mode: "0755"

- name: Template custom sandbox Dockerfile
  ansible.builtin.template:
    src: Dockerfile.sandbox.j2
    dest: /home/ubuntu/.openclaw/sandbox-build/Dockerfile
    mode: "0644"
  register: dockerfile_changed

- name: Check if custom sandbox image exists
  ansible.builtin.command: docker image inspect openclaw-sandbox-custom:latest
  register: custom_image_check
  changed_when: false
  failed_when: false

- name: Build custom sandbox Docker image
  ansible.builtin.shell: |
    docker build -t openclaw-sandbox-custom:latest /home/ubuntu/.openclaw/sandbox-build/
  args:
    executable: /bin/bash
  when: force_sandbox_rebuild | bool or dockerfile_changed.changed or custom_image_check.rc != 0
  register: docker_build_result
  failed_when: false

- name: Fall back to base image if build fails
  ansible.builtin.shell: |
    docker tag openclaw-sandbox:bookworm-slim openclaw-sandbox-custom:latest
  args:
    executable: /bin/bash
  when:
    - docker_build_result is not skipped
    - docker_build_result.rc != 0
