---
# Install and configure the mcp-adapter plugin with GitHub and Codex MCP servers.
# Skipped entirely if openclaw_mcp_adapter is not defined (in playbook.yml).
# Force reinstall with: -e force_plugin_reinstall=true

- name: Check if mcp-adapter plugin directory exists
  ansible.builtin.stat:
    path: /home/ubuntu/.openclaw/extensions/openclaw-mcp-adapter/index.ts
  register: plugin_dir

- name: Install mcp-adapter plugin
  when: not plugin_dir.stat.exists or force_plugin_reinstall | bool
  block:
    - name: Remove stale plugin config entry before reinstall
      ansible.builtin.shell: |
        set -euo pipefail
        python3 -c "
        import json, os, tempfile
        config_path = '/home/ubuntu/.openclaw/openclaw.json'
        with open(config_path) as f:
            cfg = json.load(f)
        if 'openclaw-mcp-adapter' in cfg.get('plugins', {}).get('entries', {}):
            del cfg['plugins']['entries']['openclaw-mcp-adapter']
            fd, tmp = tempfile.mkstemp(dir=os.path.dirname(config_path), suffix='.tmp')
            try:
                with os.fdopen(fd, 'w') as f:
                    json.dump(cfg, f, indent=2)
                os.rename(tmp, config_path)
            except:
                os.unlink(tmp)
                raise
        "
      args:
        executable: /bin/bash
      when: force_plugin_reinstall | bool
      changed_when: false

    - name: Remove existing plugin directory (reinstall)
      ansible.builtin.file:
        path: /home/ubuntu/.openclaw/extensions/openclaw-mcp-adapter
        state: absent
      when: force_plugin_reinstall | bool

    - name: Clone mcp-adapter fork
      ansible.builtin.git:
        repo: "{{ openclaw_mcp_adapter.source }}"
        dest: /tmp/mcp-adapter
        version: main
        depth: 1

    - name: Install plugin from local clone
      ansible.builtin.shell: |
        set -euo pipefail
        export XDG_RUNTIME_DIR=/run/user/1000
        openclaw plugins install /tmp/mcp-adapter
      args:
        executable: /bin/bash

  always:
    - name: Clean up plugin clone
      ansible.builtin.file:
        path: /tmp/mcp-adapter
        state: absent

- name: Ensure npm global prefix is configured
  ansible.builtin.shell: |
    set -euo pipefail
    PREFIX=$(npm config get prefix 2>/dev/null || echo "")
    if [ -z "$PREFIX" ] || [ "$PREFIX" = "/usr/local" ] || [ "$PREFIX" = "/usr" ]; then
        npm config set prefix "$HOME/.npm-global"
    fi
    npm config get prefix
  args:
    executable: /bin/bash
  register: npm_prefix
  changed_when: false
  check_mode: false

- name: Ensure npm global bin is in PATH profile
  ansible.builtin.lineinfile:
    path: /home/ubuntu/.profile
    line: 'export PATH="$HOME/.npm-global/bin:$PATH"'
    state: present

- name: Determine which npm packages to install
  ansible.builtin.set_fact:
    mcp_npm_packages: >-
      {{ openclaw_mcp_adapter.npm_packages
         | reject('equalto', '@openai/codex')
         | list
         + (['@openai/codex'] if (codex_auth_json | default('') | length > 0) else []) }}

- name: Install MCP server npm packages globally
  community.general.npm:
    name: "{{ item }}"
    global: true
    state: present
  environment:
    PATH: "{{ (npm_prefix.stdout_lines | last) | trim }}/bin:{{ ansible_facts['env']['PATH'] }}"
  loop: "{{ mcp_npm_packages }}"

- name: Install Claude Code CLI on host for plugin management
  community.general.npm:
    name: "@anthropic-ai/claude-code"
    version: "{{ openclaw_mcp_adapter.claude_code_version }}"
    global: true
    state: present
  environment:
    PATH: "{{ (npm_prefix.stdout_lines | last) | trim }}/bin:{{ ansible_facts['env']['PATH'] }}"
  when: claude_code_plugins is defined and claude_code_plugins.plugins | length > 0

- name: Verify Claude Code CLI version
  ansible.builtin.command: claude --version
  environment:
    PATH: "{{ (npm_prefix.stdout_lines | last) | trim }}/bin:{{ ansible_facts['env']['PATH'] }}"
  register: claude_cli_version
  changed_when: false
  failed_when: openclaw_mcp_adapter.claude_code_version not in claude_cli_version.stdout
  when: claude_code_plugins is defined and claude_code_plugins.plugins | length > 0

- name: Install Claude Code plugins for MCP containers
  when: claude_code_plugins is defined and claude_code_plugins.plugins | length > 0
  block:
    - name: Ensure plugins config directory exists
      ansible.builtin.file:
        path: "{{ claude_code_plugins.config_dir }}"
        state: directory
        mode: "0755"

    - name: Add plugin marketplaces
      ansible.builtin.shell: |
        set -euo pipefail
        output=$(claude plugin marketplace add "{{ item.repo }}" 2>&1) || {
          if echo "$output" | grep -qi "already added\|already exists\|already registered\|already installed"; then
            echo "OK_EXISTS"
            exit 0
          fi
          echo "FAILED: $output" >&2
          exit 1
        }
        echo "$output"
      args:
        executable: /bin/bash
      environment:
        CLAUDE_CONFIG_DIR: "{{ claude_code_plugins.config_dir }}"
        PATH: "{{ (npm_prefix.stdout_lines | last) | trim }}/bin:{{ ansible_facts['env']['PATH'] }}"
      loop: "{{ claude_code_plugins.marketplaces }}"
      loop_control:
        label: "{{ item.repo }}"
      register: marketplace_result
      changed_when: "'Successfully added' in marketplace_result.stdout"

    - name: Update plugin marketplaces
      ansible.builtin.shell: |
        set -euo pipefail
        claude plugin marketplace update 2>&1
      args:
        executable: /bin/bash
      environment:
        CLAUDE_CONFIG_DIR: "{{ claude_code_plugins.config_dir }}"
        PATH: "{{ (npm_prefix.stdout_lines | last) | trim }}/bin:{{ ansible_facts['env']['PATH'] }}"
      register: marketplace_update_result
      changed_when: false

    - name: Install plugins
      ansible.builtin.shell: |
        set -euo pipefail
        # Check if already installed
        if claude plugin list 2>&1 | grep -qi "{{ item }}"; then
            echo "OK_EXISTS"
            exit 0
        fi
        output=$(claude plugin install "{{ item }}" 2>&1) || {
          if echo "$output" | grep -qi "already installed"; then
            echo "OK_EXISTS"
            exit 0
          fi
          echo "FAILED: $output" >&2
          exit 1
        }
        echo "$output"
      args:
        executable: /bin/bash
      environment:
        CLAUDE_CONFIG_DIR: "{{ claude_code_plugins.config_dir }}"
        PATH: "{{ (npm_prefix.stdout_lines | last) | trim }}/bin:{{ ansible_facts['env']['PATH'] }}"
      loop: "{{ claude_code_plugins.plugins }}"
      loop_control:
        label: "{{ item }}"
      register: plugin_result
      changed_when: "'OK_EXISTS' not in plugin_result.stdout"

    - name: Verify plugins directory exists
      ansible.builtin.stat:
        path: "{{ claude_code_plugins.config_dir }}/plugins"
      register: plugins_dir
      failed_when: not plugins_dir.stat.exists or not plugins_dir.stat.isdir

    - name: Remove Claude Code MCP containers to pick up plugin changes
      ansible.builtin.shell: |
        set -euo pipefail
        containers=$(docker ps -aq --filter "label=openclaw-role=claude-code-mcp")
        if [ -n "$containers" ]; then
          echo "$containers" | xargs docker rm -f
          echo "REMOVED"
        else
          echo "NONE"
        fi
      args:
        executable: /bin/bash
      register: plugin_container_cleanup
      changed_when: "'REMOVED' in plugin_container_cleanup.stdout"
      notify: restart openclaw-gateway
      when: marketplace_result is changed or plugin_result is changed

  rescue:
    - name: Plugin installation failed — show diagnostics
      ansible.builtin.debug:
        msg: |
          Plugin installation failed.
          Marketplace add results: {{ marketplace_result.results | default([]) | map(attribute='stdout') | list }}
          Marketplace update stdout: {{ marketplace_update_result.stdout | default('(did not run)') }}
          Marketplace update stderr: {{ marketplace_update_result.stderr | default('(did not run)') }}
          Plugin results: {{ plugin_result.results | default([]) | map(attribute='stdout') | list }}
          Config dir: {{ claude_code_plugins.config_dir }}

    - name: Fail with actionable message
      ansible.builtin.fail:
        msg: "Claude Code plugin installation failed. Check diagnostics above. Re-run with -vvv for details."

- name: Resolve mcp-server-github binary path
  ansible.builtin.shell: |
    set -euo pipefail
    export PATH="{{ (npm_prefix.stdout_lines | last) | trim }}/bin:$PATH"
    BINARY=$(which mcp-server-github) || {
        echo "ERROR: mcp-server-github not found in PATH after npm install"
        echo "Expected at: {{ (npm_prefix.stdout_lines | last) | trim }}/bin/mcp-server-github"
        exit 1
    }
    echo "$BINARY"
  args:
    executable: /bin/bash
  register: github_mcp_binary
  changed_when: false

- name: Resolve qmd binary path
  ansible.builtin.shell: PATH="$HOME/.bun/bin:$PATH" which qmd
  args:
    executable: /bin/bash
  register: qmd_mcp_binary
  changed_when: false
  failed_when: false

- name: Assert qmd binary exists when qmd servers are configured
  ansible.builtin.assert:
    that: qmd_mcp_binary.rc == 0
    fail_msg: >-
      qmd binary not found but qmd servers are configured in group_vars.
      Run the qmd role first: ./scripts/provision.sh --tags qmd,plugins
  when: openclaw_mcp_adapter.servers | selectattr('type', 'equalto', 'qmd') | list | length > 0

- name: Set npm prefix bin path fact
  ansible.builtin.set_fact:
    npm_prefix_bin: "{{ (npm_prefix.stdout_lines | last) | trim }}/bin"

- name: Resolve node-exec-mcp binary path
  ansible.builtin.shell: |
    set -euo pipefail
    export PATH="{{ npm_prefix_bin }}:$PATH"
    BINARY=$(which node-exec-mcp) || {
        echo "ERROR: node-exec-mcp not found in PATH after npm install"
        echo "Expected at: {{ npm_prefix_bin }}/node-exec-mcp"
        exit 1
    }
    echo "$BINARY"
  args:
    executable: /bin/bash
  register: node_exec_mcp_binary
  changed_when: false
  when: openclaw_mcp_adapter.servers | selectattr('type', 'equalto', 'node-exec') | list | length > 0

- name: Deploy Codex auth credentials
  when: codex_auth_json | default('') | length > 0
  block:
    - name: Ensure .codex directory exists
      ansible.builtin.file:
        path: /home/ubuntu/.codex
        state: directory
        mode: "0700"

    - name: Write Codex auth.json
      ansible.builtin.copy:
        content: "{{ codex_auth_json }}"
        dest: /home/ubuntu/.codex/auth.json
        mode: "0600"
      no_log: true

- name: Verify codex auth.json is a regular file (not a directory)
  ansible.builtin.stat:
    path: /home/ubuntu/.codex/auth.json
  register: codex_auth_stat
  when: codex_auth_json | default('') | length > 0

- name: Fail if auth.json is a directory (Docker -v corruption)
  ansible.builtin.assert:
    that: codex_auth_stat.stat.isreg
    fail_msg: >-
      /home/ubuntu/.codex/auth.json is a directory, not a file.
      This is likely caused by a previous Docker bind mount when the file
      did not exist. Remove it with: rm -rf /home/ubuntu/.codex/auth.json
  when: codex_auth_json | default('') | length > 0 and codex_auth_stat.stat.exists

- name: Write Anthropic auth token file for proxy
  ansible.builtin.copy:
    content: "{{ claude_setup_token }}"
    dest: /home/ubuntu/.openclaw/anthropic-auth-token
    mode: "0600"
  no_log: true
  when: claude_setup_token | default('') | length > 0

- name: Set proxy_required fact
  ansible.builtin.set_fact:
    proxy_required: >-
      {{ (codex_auth_json | default('') | length > 0) or
         (claude_setup_token | default('') | length > 0) or
         (github_token | default('') | length > 0) or
         (github_token_manon | default('') | length > 0) or
         (github_token_tl | default('') | length > 0) }}

- name: Ensure GitHub tokens directory exists
  ansible.builtin.file:
    path: /home/ubuntu/.openclaw/github-tokens
    state: directory
    mode: "0700"
  when: proxy_required | bool

- name: Write per-agent GitHub token files
  ansible.builtin.copy:
    content: "{{ lookup('vars', item.token_var, default='') }}"
    dest: "/home/ubuntu/.openclaw/github-tokens/{{ item.agent_id }}"
    mode: "0600"
  no_log: true
  loop: "{{ openclaw_mcp_adapter.servers | selectattr('type', 'equalto', 'github') | list }}"
  loop_control:
    label: "{{ item.agent_id }}"
  when: lookup('vars', item.token_var, default='') | length > 0
  register: github_tokens_changed

- name: Create codex-proxy-net Docker network
  community.docker.docker_network:
    name: codex-proxy-net
  when: proxy_required | bool

- name: Get codex-proxy-net gateway IP
  ansible.builtin.shell: |
    docker network inspect codex-proxy-net --format '{{ '{{' }}range .IPAM.Config{{ '}}{{' }}.Gateway{{ '}}{{' }}end{{ '}}' }}'
  args:
    executable: /bin/bash
  register: codex_proxy_net_info
  changed_when: false
  when: proxy_required | bool

- name: Set codex proxy gateway IP fact
  ansible.builtin.set_fact:
    codex_proxy_gateway_ip: "{{ codex_proxy_net_info.stdout | trim }}"
  when: proxy_required | bool

- name: Allow codex-proxy-net containers to reach proxy port
  become: true
  community.general.ufw:
    rule: allow
    from_ip: "{{ codex_proxy_gateway_ip | regex_replace('\\.[0-9]+$', '.0/16') }}"
    to_port: "{{ openclaw_mcp_adapter.codex_proxy_port }}"
    proto: tcp
  when: proxy_required | bool

- name: Deploy mcp-auth-proxy
  when: proxy_required | bool
  block:
    - name: Ensure systemd user directory exists
      ansible.builtin.file:
        path: /home/ubuntu/.config/systemd/user
        state: directory
        mode: "0755"

    - name: Stop and disable old codex-token-proxy service (migration)
      ansible.builtin.systemd:
        name: codex-token-proxy
        state: stopped
        enabled: false
        scope: user
        daemon_reload: true
      environment:
        XDG_RUNTIME_DIR: /run/user/1000
      failed_when: false

    - name: Remove old codex-token-proxy service file
      ansible.builtin.file:
        path: /home/ubuntu/.config/systemd/user/codex-token-proxy.service
        state: absent

    - name: Remove old codex-token-proxy.js
      ansible.builtin.file:
        path: /home/ubuntu/.openclaw/codex-token-proxy.js
        state: absent

    - name: Template mcp-auth-proxy.js
      ansible.builtin.template:
        src: mcp-auth-proxy.js.j2
        dest: /home/ubuntu/.openclaw/mcp-auth-proxy.js
        mode: "0644"
      register: proxy_js_changed

    - name: Template mcp-auth-proxy systemd service
      ansible.builtin.template:
        src: mcp-auth-proxy.service.j2
        dest: /home/ubuntu/.config/systemd/user/mcp-auth-proxy.service
        mode: "0644"
      register: proxy_service_changed

    - name: Enable and start mcp-auth-proxy
      ansible.builtin.systemd:
        name: mcp-auth-proxy
        enabled: true
        state: "{{ 'restarted' if (proxy_js_changed is changed or proxy_service_changed is changed) else 'started' }}"
        scope: user
        daemon_reload: true
      environment:
        XDG_RUNTIME_DIR: /run/user/1000

    - name: Wait for mcp-auth-proxy to be ready
      ansible.builtin.shell: |
        curl -sf "http://{{ codex_proxy_gateway_ip }}:{{ openclaw_mcp_adapter.codex_proxy_port }}/health"
      args:
        executable: /bin/bash
      register: proxy_health
      retries: 5
      delay: 2
      until: proxy_health.rc == 0
      changed_when: false

- name: Ensure agent workspace directories exist for git proxy config
  ansible.builtin.file:
    path: "{{ item.workspace_dir }}"
    state: directory
    mode: "0755"
  loop: "{{ openclaw_workspaces }}"
  loop_control:
    label: "{{ item.agent_id }}"
  when:
    - codex_proxy_gateway_ip is defined
    - lookup('vars', (openclaw_mcp_adapter.servers | selectattr('type', 'equalto', 'github') | selectattr('agent_id', 'equalto', item.agent_id) | map(attribute='token_var') | first | default('_undefined')), default='') | length > 0

- name: Write per-agent workspace .git-proxy-config files
  ansible.builtin.copy:
    content: |
      [url "http://{{ codex_proxy_gateway_ip }}:{{ openclaw_mcp_adapter.codex_proxy_port }}/github-{{ item.agent_id }}/"]
          insteadOf = https://github.com/
          insteadOf = git@github.com:
    dest: "{{ item.workspace_dir }}/.git-proxy-config"
    mode: "0644"
  loop: "{{ openclaw_workspaces }}"
  loop_control:
    label: "{{ item.agent_id }}"
  when:
    - codex_proxy_gateway_ip is defined
    - lookup('vars', (openclaw_mcp_adapter.servers | selectattr('type', 'equalto', 'github') | selectattr('agent_id', 'equalto', item.agent_id) | map(attribute='token_var') | first | default('_undefined')), default='') | length > 0

- name: Template Codex config.toml for proxy routing
  ansible.builtin.template:
    src: codex-config.toml.j2
    dest: /home/ubuntu/.openclaw/codex-config.toml
    mode: "0644"
  when: codex_auth_json | default('') | length > 0

- name: Flush handlers to ensure proxy is restarted before image build
  ansible.builtin.meta: flush_handlers

- name: Write Claude Code validation script (bundled CLI, check source)
  ansible.builtin.copy:
    content: |
      // Claude Code CLI bundles its SDK (no separate @anthropic-ai/sdk package).
      // Validate ANTHROPIC_BASE_URL by checking the bundled source references it
      // AND by verifying the env var propagates correctly.
      const fs = require('fs');
      const cliPath = '/usr/local/lib/node_modules/@anthropic-ai/claude-code/cli.js';
      try {
        const src = fs.readFileSync(cliPath, 'utf8');
        if (src.includes('ANTHROPIC_BASE_URL')) {
          console.log('SDK_VALIDATED: cli.js reads process.env.ANTHROPIC_BASE_URL');
          process.exit(0);
        } else {
          console.log('SDK_FAILED: ANTHROPIC_BASE_URL not found in cli.js');
          process.exit(1);
        }
      } catch (err) {
        console.log('SDK_FAILED: cannot read cli.js: ' + err.message);
        process.exit(1);
      }
    dest: /tmp/validate-claude-code-sdk.js
    mode: "0644"
  changed_when: false
  when:
    - claude_setup_token | default('') | length > 0
    - codex_proxy_gateway_ip is defined

- name: Write Pi SDK validation script (actual SDK require test)
  ansible.builtin.copy:
    content: |
      // Pi MCP uses @anthropic-ai/sdk as a real dependency.
      // Validate it respects ANTHROPIC_BASE_URL.
      const sdkPath = '/usr/local/lib/node_modules/pi-mcp-server/node_modules/@anthropic-ai/sdk';
      let Anthropic;
      try {
        const mod = require(sdkPath);
        Anthropic = mod.default || mod.Anthropic || mod;
      } catch (err) {
        console.log('SDK_NOT_FOUND: ' + err.message);
        process.exit(1);
      }
      const client = new Anthropic({ apiKey: 'dummy' });
      if (client.baseURL && client.baseURL.includes('custom-test-host:9999')) {
        console.log('SDK_VALIDATED:' + client.baseURL);
        process.exit(0);
      } else {
        console.log('SDK_FAILED:' + (client.baseURL || 'undefined'));
        process.exit(1);
      }
    dest: /tmp/validate-pi-sdk.js
    mode: "0644"
  changed_when: false
  when:
    - claude_setup_token | default('') | length > 0
    - codex_proxy_gateway_ip is defined

- name: Write network validation script to temp file
  ansible.builtin.copy:
    content: |
      // Validate that the container can reach the proxy health endpoint.
      const http = require('http');
      const url = process.env.PROXY_HEALTH_URL;
      if (!url) { console.log('NET_FAIL:no PROXY_HEALTH_URL'); process.exit(1); }
      http.get(url, (res) => {
        let d = '';
        res.on('data', (c) => { d += c; });
        res.on('end', () => {
          if (res.statusCode === 200) {
            console.log('NET_OK:' + d);
            process.exit(0);
          } else {
            console.log('NET_FAIL:' + res.statusCode + ':' + d);
            process.exit(1);
          }
        });
      }).on('error', (e) => {
        console.log('NET_FAIL:' + e.message);
        process.exit(1);
      });
    dest: /tmp/validate-proxy-network.js
    mode: "0644"
  changed_when: false
  when:
    - claude_setup_token | default('') | length > 0
    - codex_proxy_gateway_ip is defined

- name: Validate ANTHROPIC_BASE_URL support in Claude Code container
  ansible.builtin.shell: |
    set -euo pipefail
    echo "=== SDK test ==="
    docker run --rm \
      --network=codex-proxy-net \
      --cap-drop ALL --security-opt no-new-privileges --read-only \
      --tmpfs /tmp:size=256m --tmpfs /home/node:size=512m,uid=1000,gid=1000 \
      -v /tmp/validate-claude-code-sdk.js:/tmp/validate-claude-code-sdk.js:ro \
      "{{ openclaw_mcp_adapter.claude_code_docker_image }}" \
      node /tmp/validate-claude-code-sdk.js
    echo "=== Network test ==="
    docker run --rm \
      --network=codex-proxy-net \
      --cap-drop ALL --security-opt no-new-privileges --read-only \
      --tmpfs /tmp:size=256m --tmpfs /home/node:size=512m,uid=1000,gid=1000 \
      -e "PROXY_HEALTH_URL=http://{{ codex_proxy_gateway_ip }}:{{ openclaw_mcp_adapter.codex_proxy_port }}/health" \
      -v /tmp/validate-proxy-network.js:/tmp/validate-proxy-network.js:ro \
      "{{ openclaw_mcp_adapter.claude_code_docker_image }}" \
      node /tmp/validate-proxy-network.js
    echo "VALIDATED: Claude Code SDK respects ANTHROPIC_BASE_URL + proxy reachable"
  args:
    executable: /bin/bash
  changed_when: false
  when:
    - claude_setup_token | default('') | length > 0
    - codex_proxy_gateway_ip is defined

- name: Validate ANTHROPIC_BASE_URL support in Pi container
  ansible.builtin.shell: |
    set -euo pipefail
    echo "=== SDK test ==="
    docker run --rm \
      --network=codex-proxy-net \
      --cap-drop ALL --security-opt no-new-privileges --read-only \
      --tmpfs /tmp:size=256m --tmpfs /home/node:size=512m,uid=1000,gid=1000 \
      -e "ANTHROPIC_BASE_URL=http://custom-test-host:9999/anthropic" \
      -v /tmp/validate-pi-sdk.js:/tmp/validate-pi-sdk.js:ro \
      --entrypoint node \
      "{{ openclaw_mcp_adapter.pi_mcp_docker_image }}" \
      /tmp/validate-pi-sdk.js
    echo "=== Network test ==="
    docker run --rm \
      --network=codex-proxy-net \
      --cap-drop ALL --security-opt no-new-privileges --read-only \
      --tmpfs /tmp:size=256m --tmpfs /home/node:size=512m,uid=1000,gid=1000 \
      -e "PROXY_HEALTH_URL=http://{{ codex_proxy_gateway_ip }}:{{ openclaw_mcp_adapter.codex_proxy_port }}/health" \
      -v /tmp/validate-proxy-network.js:/tmp/validate-proxy-network.js:ro \
      --entrypoint node \
      "{{ openclaw_mcp_adapter.pi_mcp_docker_image }}" \
      /tmp/validate-proxy-network.js
    echo "VALIDATED: Pi SDK respects ANTHROPIC_BASE_URL + proxy reachable"
  args:
    executable: /bin/bash
  changed_when: false
  when:
    - claude_setup_token | default('') | length > 0
    - codex_proxy_gateway_ip is defined

- name: Clean up validation scripts
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  changed_when: false
  loop:
    - /tmp/validate-claude-code-sdk.js
    - /tmp/validate-pi-sdk.js
    - /tmp/validate-proxy-network.js
  when:
    - claude_setup_token | default('') | length > 0

- name: Ensure agent workspace directories exist for Codex containers
  ansible.builtin.file:
    path: "{{ item.cwd }}"
    state: directory
    mode: "0755"
  loop: "{{ openclaw_mcp_adapter.servers | selectattr('type', 'equalto', 'codex') | list }}"
  loop_control:
    label: "{{ item.name }}"
  when: codex_auth_json | default('') | length > 0

- name: Ensure agent workspace directories exist for Claude Code containers
  ansible.builtin.file:
    path: "{{ item.cwd }}"
    state: directory
    mode: "0755"
  loop: "{{ openclaw_mcp_adapter.servers | selectattr('type', 'equalto', 'claude-code') | list }}"
  loop_control:
    label: "{{ item.name }}"
  when: claude_setup_token | default('') | length > 0

- name: Ensure agent workspace directories exist for Pi containers
  ansible.builtin.file:
    path: "{{ item.cwd }}"
    state: directory
    mode: "0755"
  loop: "{{ openclaw_mcp_adapter.servers | selectattr('type', 'equalto', 'pi') | list }}"
  loop_control:
    label: "{{ item.name }}"
  when: claude_setup_token | default('') | length > 0

- name: Build Codex MCP Docker image
  when: codex_auth_json | default('') | length > 0
  block:
    - name: Check if Codex MCP image exists
      ansible.builtin.command: "docker image inspect \"{{ openclaw_mcp_adapter.codex_docker_image }}\""
      register: codex_image_check
      changed_when: false
      failed_when: false

    - name: Create Codex MCP build directory
      ansible.builtin.file:
        path: /home/ubuntu/.openclaw/codex-mcp-build
        state: directory
        mode: "0755"

    - name: Template Codex MCP Dockerfile
      ansible.builtin.template:
        src: Dockerfile.codex-mcp.j2
        dest: /home/ubuntu/.openclaw/codex-mcp-build/Dockerfile
        mode: "0644"
      register: codex_dockerfile_changed

    - name: Build Codex MCP Docker image
      ansible.builtin.shell: |
        set -euo pipefail
        docker build -t "{{ openclaw_mcp_adapter.codex_docker_image }}" /home/ubuntu/.openclaw/codex-mcp-build/
      args:
        executable: /bin/bash
      when: codex_image_check.rc != 0 or codex_dockerfile_changed.changed or (force_codex_rebuild | bool)
      register: codex_image_build

    - name: Verify Codex MCP image was built
      ansible.builtin.command: "docker image inspect \"{{ openclaw_mcp_adapter.codex_docker_image }}\""
      changed_when: false

    - name: Smoke test Codex MCP image
      ansible.builtin.shell: |
        docker run --rm "{{ openclaw_mcp_adapter.codex_docker_image }}" codex --version
      args:
        executable: /bin/bash
      changed_when: false
      when: codex_image_build is changed

    - name: Smoke test Codex MCP image with hardened flags (credential-free)
      ansible.builtin.shell: |
        set -euo pipefail
        docker run --rm \
          --network=codex-proxy-net \
          --cap-drop ALL \
          --security-opt no-new-privileges \
          --read-only \
          --tmpfs /tmp \
          --tmpfs /home/node/.codex:uid=1000,gid=1000 \
          --tmpfs /home/node/.npm:uid=1000,gid=1000 \
          --tmpfs /home/node/.config:uid=1000,gid=1000 \
          --tmpfs /home/node/.cache:uid=1000,gid=1000 \
          --pids-limit 100 \
          --cpus 2 \
          --memory 2g --memory-swap 2g \
          "{{ openclaw_mcp_adapter.codex_docker_image }}" \
          sh -c 'test ! -f /home/node/.codex/auth.json && echo "no-creds-ok"'
      args:
        executable: /bin/bash
      changed_when: false
      when: codex_image_build is changed

    - name: Smoke test proxy connectivity from Codex container
      ansible.builtin.shell: |
        set -euo pipefail
        docker run --rm \
          --network=codex-proxy-net \
          --cap-drop ALL \
          --security-opt no-new-privileges \
          --read-only \
          --tmpfs /tmp \
          "{{ openclaw_mcp_adapter.codex_docker_image }}" \
          sh -c 'node -e "
            const http = require(\"http\");
            http.get(\"http://{{ codex_proxy_gateway_ip }}:{{ openclaw_mcp_adapter.codex_proxy_port }}/health\", (res) => {
              let d = \"\";
              res.on(\"data\", c => d += c);
              res.on(\"end\", () => { console.log(d); process.exit(res.statusCode === 200 ? 0 : 1); });
            }).on(\"error\", e => { console.error(e.message); process.exit(1); });
          "'
      args:
        executable: /bin/bash
      changed_when: false
      when: codex_image_build is changed

    - name: Remove Codex MCP containers after image rebuild
      ansible.builtin.shell: |
        set -euo pipefail
        containers=$(docker ps -aq --filter "label=openclaw-role=codex-mcp")
        if [ -n "$containers" ]; then
          echo "$containers" | xargs docker rm -f
        fi
      args:
        executable: /bin/bash
      register: codex_container_removal
      changed_when: codex_container_removal.stdout | length > 0
      when: codex_image_build is changed

    - name: Verify no Codex MCP containers remain after cleanup
      ansible.builtin.shell: |
        set -euo pipefail
        count=$(docker ps -aq --filter "label=openclaw-role=codex-mcp" | wc -l)
        if [ "$count" -ne 0 ]; then
          echo "ERROR: $count Codex MCP containers still present after removal"
          docker ps -a --filter "label=openclaw-role=codex-mcp" --format '{{ '{{' }}.ID{{ '}}' }} {{ '{{' }}.Image{{ '}}' }} {{ '{{' }}.Status{{ '}}' }}'
          exit 1
        fi
      args:
        executable: /bin/bash
      changed_when: false
      when: codex_container_removal is changed

    - name: Restart gateway to pick up new Codex MCP image
      ansible.builtin.systemd:
        name: openclaw-gateway
        state: restarted
        scope: user
      become: false
      environment:
        XDG_RUNTIME_DIR: /run/user/1000
      when: codex_image_build is changed

    - name: Wait for gateway to be healthy after Codex image rebuild
      ansible.builtin.command: openclaw health
      register: codex_health_check
      retries: 5
      delay: 3
      until: codex_health_check.rc == 0
      changed_when: false
      when: codex_image_build is changed

  rescue:
    - name: Capture gateway logs for diagnosis
      ansible.builtin.shell: |
        export XDG_RUNTIME_DIR=/run/user/1000
        journalctl --user -u openclaw-gateway --since "2 minutes ago" --no-pager | tail -50
      args:
        executable: /bin/bash
      register: gateway_crash_logs
      failed_when: false

    - name: Report gateway failure with diagnostic context
      ansible.builtin.fail:
        msg: |
          Gateway failed health check after Codex MCP image rebuild.
          Recent gateway logs:
          {{ gateway_crash_logs.stdout | default('(no logs captured)') }}
          Manual recovery: ssh ubuntu@<host> 'XDG_RUNTIME_DIR=/run/user/1000 journalctl --user -u openclaw-gateway -n 100'

- name: Build Claude Code MCP Docker image
  when: claude_setup_token | default('') | length > 0
  block:
    - name: Check if Claude Code MCP image exists
      ansible.builtin.command: "docker image inspect \"{{ openclaw_mcp_adapter.claude_code_docker_image }}\""
      register: claude_code_image_check
      changed_when: false
      failed_when: false

    - name: Create Claude Code MCP build directory
      ansible.builtin.file:
        path: /home/ubuntu/.openclaw/claude-code-mcp-build
        state: directory
        mode: "0755"

    - name: Template Claude Code MCP Dockerfile
      ansible.builtin.template:
        src: Dockerfile.claude-code-mcp.j2
        dest: /home/ubuntu/.openclaw/claude-code-mcp-build/Dockerfile
        mode: "0644"
      register: claude_code_dockerfile_changed

    - name: Build Claude Code MCP Docker image
      ansible.builtin.shell: |
        set -euo pipefail
        docker build -t "{{ openclaw_mcp_adapter.claude_code_docker_image }}" /home/ubuntu/.openclaw/claude-code-mcp-build/
      args:
        executable: /bin/bash
      when: claude_code_image_check.rc != 0 or claude_code_dockerfile_changed.changed or (force_claude_code_rebuild | bool)
      register: claude_code_image_build

    - name: Verify Claude Code MCP image was built
      ansible.builtin.command: "docker image inspect \"{{ openclaw_mcp_adapter.claude_code_docker_image }}\""
      changed_when: false

    - name: Smoke test Claude Code MCP image (version check)
      ansible.builtin.shell: |
        docker run --rm "{{ openclaw_mcp_adapter.claude_code_docker_image }}" claude --version
      args:
        executable: /bin/bash
      changed_when: false
      when: claude_code_image_build is changed

    - name: Smoke test Claude Code MCP image with hardened flags
      ansible.builtin.shell: |
        set -euo pipefail
        docker run --rm \
          --network=codex-proxy-net \
          --cap-drop ALL \
          --security-opt no-new-privileges \
          --read-only \
          --tmpfs /tmp:size=256m \
          --tmpfs /home/node:size=512m,uid=1000,gid=1000 \
          -e ANTHROPIC_API_KEY=proxy \
          -e "ANTHROPIC_BASE_URL=http://{{ codex_proxy_gateway_ip }}:{{ openclaw_mcp_adapter.codex_proxy_port }}/anthropic" \
          "{{ openclaw_mcp_adapter.claude_code_docker_image }}" \
          sh -c 'test -x $(which claude) && test -x $(which claude-code-mcp) && echo "binaries-ok"'
      args:
        executable: /bin/bash
      changed_when: false
      when: claude_code_image_build is changed

    - name: Remove Claude Code MCP containers after image rebuild
      ansible.builtin.shell: |
        set -euo pipefail
        containers=$(docker ps -aq --filter "label=openclaw-role=claude-code-mcp")
        if [ -n "$containers" ]; then
          echo "$containers" | xargs docker rm -f
        fi
      args:
        executable: /bin/bash
      register: claude_code_container_removal
      changed_when: claude_code_container_removal.stdout | length > 0
      when: claude_code_image_build is changed

    - name: Verify no Claude Code MCP containers remain after cleanup
      ansible.builtin.shell: |
        set -euo pipefail
        count=$(docker ps -aq --filter "label=openclaw-role=claude-code-mcp" | wc -l)
        if [ "$count" -ne 0 ]; then
          echo "ERROR: $count Claude Code MCP containers still present after removal"
          docker ps -a --filter "label=openclaw-role=claude-code-mcp" --format '{{ '{{' }}.ID{{ '}}' }} {{ '{{' }}.Image{{ '}}' }} {{ '{{' }}.Status{{ '}}' }}'
          exit 1
        fi
      args:
        executable: /bin/bash
      changed_when: false
      when: claude_code_container_removal is changed

    - name: Restart gateway to pick up new Claude Code MCP image
      ansible.builtin.systemd:
        name: openclaw-gateway
        state: restarted
        scope: user
      become: false
      environment:
        XDG_RUNTIME_DIR: /run/user/1000
      when: claude_code_image_build is changed

    - name: Wait for gateway to be healthy after Claude Code image rebuild
      ansible.builtin.command: openclaw health
      register: claude_code_health_check
      retries: 5
      delay: 3
      until: claude_code_health_check.rc == 0
      changed_when: false
      when: claude_code_image_build is changed

  rescue:
    - name: Capture gateway logs for Claude Code diagnosis
      ansible.builtin.shell: |
        export XDG_RUNTIME_DIR=/run/user/1000
        journalctl --user -u openclaw-gateway --since "2 minutes ago" --no-pager | tail -50
      args:
        executable: /bin/bash
      register: gateway_crash_logs_claude
      failed_when: false

    - name: Report gateway failure with Claude Code diagnostic context
      ansible.builtin.fail:
        msg: |
          Gateway failed health check after Claude Code MCP image rebuild.
          Recent gateway logs:
          {{ gateway_crash_logs_claude.stdout | default('(no logs captured)') }}
          Manual recovery: ssh ubuntu@<host> 'XDG_RUNTIME_DIR=/run/user/1000 journalctl --user -u openclaw-gateway -n 100'

- name: Build Pi MCP Docker image
  when: claude_setup_token | default('') | length > 0
  block:
    - name: Check if Pi MCP image exists
      ansible.builtin.command: "docker image inspect \"{{ openclaw_mcp_adapter.pi_mcp_docker_image }}\""
      register: pi_mcp_image_check
      changed_when: false
      failed_when: false

    - name: Create Pi MCP build directory
      ansible.builtin.file:
        path: /home/ubuntu/.openclaw/pi-mcp-build
        state: directory
        mode: "0755"

    - name: Template Pi MCP Dockerfile
      ansible.builtin.template:
        src: Dockerfile.pi-mcp.j2
        dest: /home/ubuntu/.openclaw/pi-mcp-build/Dockerfile
        mode: "0644"
      register: pi_mcp_dockerfile_changed

    - name: Build Pi MCP Docker image
      ansible.builtin.shell: |
        set -euo pipefail
        docker build -t "{{ openclaw_mcp_adapter.pi_mcp_docker_image }}" /home/ubuntu/.openclaw/pi-mcp-build/
      args:
        executable: /bin/bash
      when: pi_mcp_image_check.rc != 0 or pi_mcp_dockerfile_changed.changed or (force_pi_mcp_rebuild | bool)
      register: pi_mcp_image_build

    - name: Verify Pi MCP image was built
      ansible.builtin.command: "docker image inspect \"{{ openclaw_mcp_adapter.pi_mcp_docker_image }}\""
      changed_when: false

    - name: Smoke test Pi MCP image (binary check)
      ansible.builtin.shell: |
        docker run --rm --entrypoint sh "{{ openclaw_mcp_adapter.pi_mcp_docker_image }}" -c 'which pi-mcp-server && echo "binary-ok"'
      args:
        executable: /bin/bash
      changed_when: false
      when: pi_mcp_image_build is changed

    - name: Smoke test Pi MCP image with hardened flags
      ansible.builtin.shell: |
        set -euo pipefail
        docker run --rm \
          --network=codex-proxy-net \
          --cap-drop ALL \
          --security-opt no-new-privileges \
          --read-only \
          --tmpfs /tmp:size=256m \
          --tmpfs /home/node:size=512m,uid=1000,gid=1000 \
          -e ANTHROPIC_OAUTH_TOKEN=sk-ant-oat-proxy \
          -e "ANTHROPIC_BASE_URL=http://{{ codex_proxy_gateway_ip }}:{{ openclaw_mcp_adapter.codex_proxy_port }}/anthropic" \
          --entrypoint sh \
          "{{ openclaw_mcp_adapter.pi_mcp_docker_image }}" \
          -c 'test -x $(which pi-mcp-server) && echo "hardened-ok"'
      args:
        executable: /bin/bash
      changed_when: false
      when: pi_mcp_image_build is changed

    - name: Smoke test Pi MCP auth via proxy (startup check)
      ansible.builtin.shell: |
        set -euo pipefail
        # Verify the server starts and routes through the proxy.
        # With proxy pattern, the real token is injected server-side.
        RESULT=$(echo "" | timeout 5 docker run --rm -i \
          --cap-drop ALL --security-opt no-new-privileges --read-only \
          --tmpfs /tmp:size=256m --tmpfs /home/node:size=512m,uid=1000,gid=1000 \
          --network=codex-proxy-net \
          -e ANTHROPIC_OAUTH_TOKEN=sk-ant-oat-proxy \
          -e PI_MCP_PROVIDER=anthropic \
          -e "PI_MCP_MODEL={{ openclaw_mcp_adapter.pi_mcp_model }}" \
          -e PI_MCP_CWD=/tmp \
          -e PI_MCP_SANDBOX=false \
          -e "ANTHROPIC_BASE_URL=http://{{ codex_proxy_gateway_ip }}:{{ openclaw_mcp_adapter.codex_proxy_port }}/anthropic" \
          "{{ openclaw_mcp_adapter.pi_mcp_docker_image }}" \
          2>&1 || true)
        if echo "$RESULT" | grep -q "pi-mcp-server started"; then
            echo "auth-smoke-ok: server initialized via proxy"
        elif echo "$RESULT" | grep -qi "invalid.*api.*key\|unauthorized\|authentication"; then
            echo "FAIL: Auth rejected through proxy"
            echo "$RESULT" | tail -10
            exit 1
        else
            echo "WARNING: Unexpected startup output:"
            echo "$RESULT" | tail -10
        fi
      args:
        executable: /bin/bash
      changed_when: false
      failed_when: false
      register: pi_auth_smoke
      when: pi_mcp_image_build is changed

    - name: Show Pi auth smoke test result
      ansible.builtin.debug:
        var: pi_auth_smoke.stdout_lines
      when: pi_mcp_image_build is changed and pi_auth_smoke.stdout is defined

    - name: Remove Pi MCP containers after image rebuild
      ansible.builtin.shell: |
        set -euo pipefail
        containers=$(docker ps -aq --filter "label=openclaw-role=pi-mcp")
        if [ -n "$containers" ]; then
          echo "$containers" | xargs docker rm -f
        fi
      args:
        executable: /bin/bash
      register: pi_mcp_container_removal
      changed_when: pi_mcp_container_removal.stdout | length > 0
      when: pi_mcp_image_build is changed

    - name: Verify no Pi MCP containers remain after cleanup
      ansible.builtin.shell: |
        set -euo pipefail
        count=$(docker ps -aq --filter "label=openclaw-role=pi-mcp" | wc -l)
        if [ "$count" -ne 0 ]; then
          echo "ERROR: $count Pi MCP containers still present after removal"
          docker ps -a --filter "label=openclaw-role=pi-mcp" --format '{{ '{{' }}.ID{{ '}}' }} {{ '{{' }}.Image{{ '}}' }} {{ '{{' }}.Status{{ '}}' }}'
          exit 1
        fi
      args:
        executable: /bin/bash
      changed_when: false
      when: pi_mcp_container_removal is changed

    - name: Restart gateway to pick up new Pi MCP image
      ansible.builtin.systemd:
        name: openclaw-gateway
        state: restarted
        scope: user
      become: false
      environment:
        XDG_RUNTIME_DIR: /run/user/1000
      when: pi_mcp_image_build is changed

    - name: Wait for gateway to be healthy after Pi image rebuild
      ansible.builtin.command: openclaw health
      register: pi_health_check
      retries: 5
      delay: 3
      until: pi_health_check.rc == 0
      changed_when: false
      when: pi_mcp_image_build is changed

  rescue:
    - name: Capture gateway logs for Pi MCP diagnosis
      ansible.builtin.shell: |
        export XDG_RUNTIME_DIR=/run/user/1000
        journalctl --user -u openclaw-gateway --since "2 minutes ago" --no-pager | tail -50
      args:
        executable: /bin/bash
      register: gateway_crash_logs_pi
      failed_when: false

    - name: Report gateway failure with Pi MCP diagnostic context
      ansible.builtin.fail:
        msg: |
          Gateway failed health check after Pi MCP image rebuild.
          Recent gateway logs:
          {{ gateway_crash_logs_pi.stdout | default('(no logs captured)') }}
          Manual recovery: ssh ubuntu@<host> 'XDG_RUNTIME_DIR=/run/user/1000 journalctl --user -u openclaw-gateway -n 100'

- name: Validate token variable names are defined
  ansible.builtin.assert:
    that:
      - item.token_var in hostvars[inventory_hostname]
    fail_msg: >-
      Server '{{ item.name }}' references token_var '{{ item.token_var }}'
      which is not a defined variable. Check group_vars/all.yml and provision.sh.
    quiet: true
  loop: "{{ openclaw_mcp_adapter.servers | selectattr('token_var', 'defined') | list }}"
  loop_control:
    label: "{{ item.name }}"

- name: Write server tokens to temp files (de-duplicated by token_var)
  ansible.builtin.copy:
    content: "{{ lookup('vars', item, default='') }}"
    dest: "/tmp/ansible-mcp-token-{{ item }}"
    mode: "0600"
  no_log: true
  changed_when: false
  loop: "{{ openclaw_mcp_adapter.servers | selectattr('token_var', 'defined') | map(attribute='token_var') | unique | list }}"

- name: Write Claude setup token to temp file
  ansible.builtin.copy:
    content: "{{ claude_setup_token }}"
    dest: "/tmp/ansible-mcp-claude-setup-token"
    mode: "0600"
  no_log: true
  changed_when: false
  when: claude_setup_token | default('') | length > 0

- name: Build and write plugin config JSON
  ansible.builtin.shell: |
    set -euo pipefail
    GITHUB_BINARY="{{ github_mcp_binary.stdout | trim }}"
    TOOL_PREFIX='{{ openclaw_mcp_adapter.tool_prefix | to_json }}'
    CODEX_SANDBOX="{{ openclaw_mcp_adapter.codex_sandbox | default('workspace-write') }}"
    CODEX_APPROVAL="{{ openclaw_mcp_adapter.codex_approval | default('never') }}"
    # Build servers array
    SERVERS="[]"

    # GitHub servers — only include when token is non-empty
    {% for srv in openclaw_mcp_adapter.servers | selectattr('type', 'equalto', 'github') %}
    TOKEN_FILE="/tmp/ansible-mcp-token-{{ srv.token_var }}"
    if [ ! -f "$TOKEN_FILE" ]; then
        echo "ERROR: Token file $TOKEN_FILE is missing — write task may have failed"
        exit 1
    fi
    TOKEN=$(cat "$TOKEN_FILE")
    if [ -n "$TOKEN" ]; then
        SERVERS=$(echo "$SERVERS" | jq --arg name "{{ srv.name }}" \
            --arg cmd "$GITHUB_BINARY" \
            --arg token "$TOKEN" \
            '. + [{name: $name, transport: "stdio", command: $cmd, env: {GITHUB_PERSONAL_ACCESS_TOKEN: $token}}]')
    fi
    {% endfor %}

    # Codex servers — containerized with docker run -i (stdio piped through Docker)
    # Security: containers have NO credentials. Auth is injected by mcp-auth-proxy (formerly codex-token-proxy)
    # running on codex-proxy-net. Sandbox containers on default bridge cannot reach proxy.
    CODEX_IMAGE="{{ openclaw_mcp_adapter.codex_docker_image }}"
    CODEX_MEM="{{ openclaw_mcp_adapter.codex_memory_limit | default('2g') }}"
    PROXY_GW="{{ codex_proxy_gateway_ip | default('') }}"
    if [ -f "/home/ubuntu/.codex/auth.json" ] && [ -n "$PROXY_GW" ]; then
    {% for srv in openclaw_mcp_adapter.servers | selectattr('type', 'equalto', 'codex') %}
        DOCKER_ARGS=$(jq -n \
            --arg ws "{{ srv.cwd }}" \
            --arg img "$CODEX_IMAGE" \
            --arg agent "{{ srv.agent_id }}" \
            --arg mem "$CODEX_MEM" \
            --arg sandbox "$CODEX_SANDBOX" \
            --arg approval "$CODEX_APPROVAL" \
            '["run","--rm","-i","--init","--network=codex-proxy-net",
              "--cap-drop","ALL",
              "--security-opt","no-new-privileges",
              "--read-only",
              "--tmpfs","/tmp",
              "--tmpfs","/home/node/.codex:uid=1000,gid=1000",
              "--tmpfs","/home/node/.npm:uid=1000,gid=1000",
              "--tmpfs","/home/node/.config:uid=1000,gid=1000",
              "--tmpfs","/home/node/.cache:uid=1000,gid=1000",
              "--pids-limit","100",
              "--cpus","2",
              ("--memory=" + $mem),("--memory-swap=" + $mem),
              "--label","openclaw-role=codex-mcp",
              "--label",("openclaw-agent=" + $agent),
              "--mount",("type=bind,source=" + $ws + ",target=/workspace"),
              "--mount","type=bind,source=/home/ubuntu/.openclaw/codex-config.toml,target=/home/node/.codex/config.toml,readonly",
              "-e","CODEX_PROXY_TOKEN=proxy",
              "-w","/workspace",
              $img,
              "codex","mcp-server",
              "-c",("sandbox_mode=" + $sandbox),
              "-c",("approval_policy=" + $approval)]')
        SERVERS=$(echo "$SERVERS" | jq --arg name "{{ srv.name }}" --argjson args "$DOCKER_ARGS" \
            '. + [{name: $name, transport: "stdio", command: "docker", args: $args}]')
    {% endfor %}
    fi

    # Claude Code servers — containerized with docker run -i (stdio piped through Docker)
    # Security: containers have NO credentials. Auth is injected by the proxy
    # running on codex-proxy-net. ANTHROPIC_BASE_URL routes API calls through proxy.
    CLAUDE_IMAGE="{{ openclaw_mcp_adapter.claude_code_docker_image }}"
    CLAUDE_MEM="{{ openclaw_mcp_adapter.claude_code_memory_limit | default('2g') }}"
    if [ -n "$PROXY_GW" ]; then
    {% if claude_code_plugins is defined and claude_code_plugins.plugins | default([]) | length > 0 %}
    CLAUDE_CMD="mkdir -p /home/node/.claude && cp -a /opt/claude-config/. /home/node/.claude/ && exec claude-code-mcp"
    {% else %}
    CLAUDE_CMD="exec claude-code-mcp"
    {% endif %}
    {% for srv in openclaw_mcp_adapter.servers | selectattr('type', 'equalto', 'claude-code') %}
        DOCKER_ARGS=$(jq -n \
            --arg ws "{{ srv.cwd }}" \
            --arg img "$CLAUDE_IMAGE" \
            --arg agent "{{ srv.agent_id }}" \
            --arg mem "$CLAUDE_MEM" \
            --arg base_url "http://${PROXY_GW}:{{ openclaw_mcp_adapter.codex_proxy_port }}/anthropic" \
    {% if claude_code_plugins is defined and claude_code_plugins.plugins | default([]) | length > 0 %}
            --arg config_dir "{{ claude_code_plugins.config_dir }}" \
    {% endif %}
            --arg cmd "$CLAUDE_CMD" \
            '["run","--rm","-i","--init","--network=codex-proxy-net",
              "--cap-drop","ALL",
              "--security-opt","no-new-privileges",
              "--read-only",
              "--tmpfs","/tmp:size=256m",
              "--tmpfs","/home/node:size=512m,uid=1000,gid=1000",
              "--pids-limit","300",
              "--cpus","2",
              ("--memory=" + $mem),("--memory-swap=" + $mem),
              "--label","openclaw-role=claude-code-mcp",
              "--label",("openclaw-agent=" + $agent),
              "--mount",("type=bind,source=" + $ws + ",target=/workspace"),
    {% if claude_code_plugins is defined and claude_code_plugins.plugins | default([]) | length > 0 %}
              "--mount",("type=bind,source=" + $config_dir + ",target=/opt/claude-config,readonly"),
    {% endif %}
              "-e","ANTHROPIC_API_KEY=proxy",
              "-e",("ANTHROPIC_BASE_URL=" + $base_url),
              "-e","ENABLE_LSP_TOOL=1",
              "-e","CLAUDE_CODE_SUBAGENT_MODEL=opus",
              "-w","/workspace",
              $img,
              "sh","-c",$cmd]')
        SERVERS=$(echo "$SERVERS" | jq --arg name "{{ srv.name }}" --argjson args "$DOCKER_ARGS" \
            '. + [{name: $name, transport: "stdio", command: "docker", args: $args}]')
    {% endfor %}
    fi

    # Pi MCP servers — containerized with docker run -i (stdio piped through Docker)
    # Security: containers have NO credentials. Auth is injected by the proxy
    # running on codex-proxy-net. ANTHROPIC_BASE_URL routes API calls through proxy.
    PI_IMAGE="{{ openclaw_mcp_adapter.pi_mcp_docker_image }}"
    PI_MEM="{{ openclaw_mcp_adapter.pi_mcp_memory_limit | default('1g') }}"
    PI_MODEL="{{ openclaw_mcp_adapter.pi_mcp_model | default('claude-sonnet-4-5-20250929') }}"
    PI_THINKING="{{ openclaw_mcp_adapter.pi_mcp_thinking | default('medium') }}"
    if [ -n "$PROXY_GW" ]; then
    {% for srv in openclaw_mcp_adapter.servers | selectattr('type', 'equalto', 'pi') %}
        DOCKER_ARGS=$(jq -n \
            --arg ws "{{ srv.cwd }}" \
            --arg img "$PI_IMAGE" \
            --arg agent "{{ srv.agent_id }}" \
            --arg mem "$PI_MEM" \
            --arg model "$PI_MODEL" \
            --arg thinking "$PI_THINKING" \
            --arg base_url "http://${PROXY_GW}:{{ openclaw_mcp_adapter.codex_proxy_port }}/anthropic" \
            '["run","--rm","-i","--init","--network=codex-proxy-net",
              "--cap-drop","ALL",
              "--security-opt","no-new-privileges",
              "--read-only",
              "--tmpfs","/tmp:size=256m",
              "--tmpfs","/home/node:size=512m,uid=1000,gid=1000",
              "--pids-limit","100",
              "--cpus","2",
              ("--memory=" + $mem),("--memory-swap=" + $mem),
              "--label","openclaw-role=pi-mcp",
              "--label",("openclaw-agent=" + $agent),
              "--mount",("type=bind,source=" + $ws + ",target=/workspace"),
              "-e","ANTHROPIC_OAUTH_TOKEN=sk-ant-oat-proxy",
              "-e","PI_MCP_PROVIDER=anthropic",
              "-e",("PI_MCP_MODEL=" + $model),
              "-e",("PI_MCP_THINKING=" + $thinking),
              "-e","PI_MCP_CWD=/workspace",
              "-e","PI_MCP_SANDBOX=false",
              "-e","PI_MCP_MAX_SESSIONS=10",
              "-e","PI_MCP_SESSION_IDLE_TIMEOUT=1800",
              "-e",("ANTHROPIC_BASE_URL=" + $base_url),
              "-w","/workspace",
              $img]')
        SERVERS=$(echo "$SERVERS" | jq --arg name "{{ srv.name }}" --argjson args "$DOCKER_ARGS" \
            '. + [{name: $name, transport: "stdio", command: "docker", args: $args}]')
    {% endfor %}
    fi

    # qmd servers — local semantic search (no tokens/proxy needed)
    QMD_BINARY="{{ (qmd_mcp_binary.stdout | default('')) | trim }}"
    if [ -n "$QMD_BINARY" ] && [ -x "$QMD_BINARY" ]; then
    {% for srv in openclaw_mcp_adapter.servers | selectattr('type', 'equalto', 'qmd') %}
        QMD_CONFIG="{{ srv.cwd }}/.qmd"
        QMD_INDEX="{{ srv.cwd }}/.qmd/index.sqlite"
        SERVERS=$(echo "$SERVERS" | jq --arg name "{{ srv.name }}" \
            --arg cmd "$QMD_BINARY" \
            --arg cwd "{{ srv.cwd }}" \
            --arg config_dir "$QMD_CONFIG" \
            --arg index_path "$QMD_INDEX" \
            '. + [{name: $name, transport: "stdio", command: $cmd, args: ["mcp"], cwd: $cwd, env: {QMD_CONFIG_DIR: $config_dir, INDEX_PATH: $index_path}}]')
    {% endfor %}
    else
        echo "NOTE: qmd binary not found, skipping qmd MCP servers"
    fi

    # node-exec: Mac shell access via openclaw nodes run (no Docker, no credentials)
    NODE_EXEC_BINARY="{{ ((node_exec_mcp_binary.stdout_lines | default([''])) | last) | trim }}"
    OPENCLAW_BIN=$(which openclaw 2>/dev/null || echo "")
    NODE_ID=$(XDG_RUNTIME_DIR=/run/user/1000 openclaw config get tools.exec.node 2>/dev/null || echo "")
    if [ -n "$NODE_ID" ] && [ -n "$OPENCLAW_BIN" ] && [ -x "$NODE_EXEC_BINARY" ]; then
    {% for srv in openclaw_mcp_adapter.servers | selectattr('type', 'equalto', 'node-exec') %}
        SERVERS=$(echo "$SERVERS" | jq --arg name "{{ srv.name }}" \
            --arg cmd "$NODE_EXEC_BINARY" \
            --arg node_id "$NODE_ID" \
            --arg openclaw_bin "$OPENCLAW_BIN" \
            '. + [{name: $name, transport: "stdio", command: $cmd, env: {NODE_ID: $node_id, OPENCLAW_BIN: $openclaw_bin, XDG_RUNTIME_DIR: "/run/user/1000"}}]')
    {% endfor %}
    else
        echo "NOTE: Skipping node-exec MCP servers (node_id='${NODE_ID}', binary='${NODE_EXEC_BINARY}')" >&2
    fi

    # Build final config
    CONFIG=$(jq -n --argjson prefix "$TOOL_PREFIX" --argjson servers "$SERVERS" \
        '{toolPrefix: $prefix, servers: $servers}')

    echo "$CONFIG" > /tmp/ansible-plugin-config
    chmod 600 /tmp/ansible-plugin-config
  args:
    executable: /bin/bash
  changed_when: false
  # no_log omitted intentionally — tokens are in temp files, not in this template.
  # Errors here (jq failures, missing files) must be visible for debugging.

- name: Configure mcp-adapter plugin
  block:
    - name: Set plugin config and enable
      ansible.builtin.shell: |
        set -euo pipefail
        export XDG_RUNTIME_DIR=/run/user/1000
        DESIRED=$(cat /tmp/ansible-plugin-config)
        CHANGED=""

        # Compare config JSON (normalized)
        CURRENT=$(openclaw config get plugins.entries.openclaw-mcp-adapter.config 2>/dev/null) || CURRENT=""
        C_NORM=$(echo "$CURRENT" | jq -cS '.' 2>/dev/null || echo "PARSE_FAIL")
        D_NORM=$(echo "$DESIRED" | jq -cS '.')
        if [ "$C_NORM" = "PARSE_FAIL" ] || [ "$C_NORM" != "$D_NORM" ]; then
            openclaw config set plugins.entries.openclaw-mcp-adapter.config --json "$DESIRED"
            CHANGED="yes"
        fi

        # Check enabled state
        ENABLED=$(openclaw config get plugins.entries.openclaw-mcp-adapter.enabled 2>/dev/null) || ENABLED=""
        if [ "$ENABLED" != "true" ]; then
            openclaw config set plugins.entries.openclaw-mcp-adapter.enabled true
            CHANGED="yes"
        fi

        if [ -n "$CHANGED" ]; then echo "UPDATED"; else echo "OK"; fi
      args:
        executable: /bin/bash
      no_log: true
      register: plugin_config_result
      changed_when: "'UPDATED' in plugin_config_result.stdout"
      notify: restart openclaw-gateway

    - name: Verify plugin config was applied
      ansible.builtin.shell: |
        set -euo pipefail
        export XDG_RUNTIME_DIR=/run/user/1000
        ENABLED=$(openclaw config get plugins.entries.openclaw-mcp-adapter.enabled 2>&1) || {
            echo "ERROR: Failed to read plugin enabled state after config set"
            exit 1
        }
        if [ "$ENABLED" != "true" ]; then
            echo "ERROR: Plugin enabled state is '$ENABLED', expected 'true'"
            exit 1
        fi
      args:
        executable: /bin/bash
      changed_when: false

  always:
    - name: Clean up plugin config temp file
      ansible.builtin.file:
        path: /tmp/ansible-plugin-config
        state: absent
      changed_when: false

    - name: Clean up token temp files
      ansible.builtin.file:
        path: "/tmp/ansible-mcp-token-{{ item }}"
        state: absent
      changed_when: false
      loop: "{{ openclaw_mcp_adapter.servers | selectattr('token_var', 'defined') | map(attribute='token_var') | unique | list }}"

    - name: Clean up Claude setup token temp file
      ansible.builtin.file:
        path: /tmp/ansible-mcp-claude-setup-token
        state: absent
      changed_when: false

- name: Flush handlers to restart gateway before verification
  ansible.builtin.meta: flush_handlers

- name: Wait for gateway to stabilize after plugin config
  ansible.builtin.pause:
    seconds: 5

- name: Verify mcp-adapter plugin is loaded
  ansible.builtin.shell: |
    export XDG_RUNTIME_DIR=/run/user/1000
    openclaw plugins list --json | jq -e '.plugins[] | select(.id == "openclaw-mcp-adapter")'
  args:
    executable: /bin/bash
  changed_when: false

- name: Check gateway logs for mcp-adapter errors
  ansible.builtin.shell: |
    set -euo pipefail
    export XDG_RUNTIME_DIR=/run/user/1000
    LOGS=$(journalctl --user -u openclaw-gateway --since "30 seconds ago" --no-pager)
    if echo "$LOGS" | grep -qi "mcp.*error\|error.*mcp\|failed.*mcp-adapter\|docker.*error\|container.*failed\|image.*not found"; then
        echo "ERROR: Gateway logs contain MCP adapter errors:"
        echo "$LOGS" | grep -i "mcp"
        exit 1
    fi
    echo "$LOGS" | grep -i "mcp" || echo "No mcp-adapter log entries yet (normal for lazy-loaded plugins)"
  args:
    executable: /bin/bash
  register: mcp_logs
  changed_when: false

- name: Show mcp-adapter log status
  ansible.builtin.debug:
    var: mcp_logs.stdout_lines

# --- Per-agent MCP tool scoping ---
# Each agent denies all MCP server tool prefixes except its own.
# Glob patterns use server name + "_*" suffix (e.g. "github-manon_*", "codex-tl_*").
# Safe because toolPrefix uses "_" while server names use "-" as separator,
# so "github_*" cannot match "github-manon_*". Server names must never contain "_".
# e.g. agent "main" gets deny: ["github-manon_*", "github-tl_*", "codex-manon_*", "codex-tl_*", "claude-manon_*", "claude-tl_*"]

- name: Validate server agent_id values match defined agents
  ansible.builtin.assert:
    that:
      - item.agent_id in (openclaw_agents | map(attribute='id') | list)
    fail_msg: >-
      Server '{{ item.name }}' has agent_id '{{ item.agent_id }}'
      which does not match any agent in openclaw_agents.
      Valid agent IDs: {{ openclaw_agents | map(attribute='id') | list }}
    quiet: true
  loop: "{{ openclaw_mcp_adapter.servers }}"
  loop_control:
    label: "{{ item.name }}"

- name: Get agent list for index resolution
  ansible.builtin.shell: |
    export XDG_RUNTIME_DIR=/run/user/1000
    openclaw agents list --json
  args:
    executable: /bin/bash
  register: agents_list_json
  changed_when: false

- name: Set per-agent tool deny rules for MCP tools
  ansible.builtin.shell: |
    set -euo pipefail
    export XDG_RUNTIME_DIR=/run/user/1000
    AGENTS_JSON='{{ agents_list_json.stdout }}'
    AGENT_INDEX=$(echo "$AGENTS_JSON" | jq -r 'to_entries[] | select(.value.id == "{{ item.id }}") | .key')
    if [ -z "$AGENT_INDEX" ]; then
        echo "SKIP: Agent '{{ item.id }}' not found in agents list"
        exit 0
    fi
    CURRENT=$(openclaw config get "agents.list.${AGENT_INDEX}.tools.deny" 2>&1) || {
        if echo "$CURRENT" | grep -qi "not set\|not found\|does not exist\|undefined"; then
            CURRENT="[]"
        else
            echo "ERROR reading tools.deny for {{ item.id }}: $CURRENT" >&2
            exit 1
        fi
    }
    DESIRED='{{ deny_list | to_json }}'
    C_NORM=$(echo "$CURRENT" | jq -cS 'sort' 2>/dev/null || echo "PARSE_FAIL")
    D_NORM=$(echo "$DESIRED" | jq -cS 'sort')
    if [ "$C_NORM" != "PARSE_FAIL" ] && [ "$C_NORM" = "$D_NORM" ]; then
        echo "OK"
    else
        openclaw config set "agents.list.${AGENT_INDEX}.tools.deny" --json "$DESIRED"
        echo "UPDATED"
    fi
  args:
    executable: /bin/bash
  vars:
    deny_list: >-
      {{ openclaw_mcp_adapter.servers
         | rejectattr('agent_id', 'equalto', item.id)
         | map(attribute='name')
         | map('regex_replace', '$', '_*')
         | list }}
  loop: "{{ openclaw_agents }}"
  loop_control:
    label: "{{ item.id }}"
  register: deny_result
  changed_when: "'UPDATED' in deny_result.stdout"
  notify: restart openclaw-gateway

# --- Disable built-in memorySearch when qmd servers are registered ---
# Moved here from qmd role (Fix #2): only disable AFTER qmd MCP servers are
# confirmed in the plugin config. If provisioning fails between qmd and plugins,
# agents still have memorySearch as fallback.

- name: Check if qmd servers are in plugin config
  ansible.builtin.shell: |
    set -euo pipefail
    export XDG_RUNTIME_DIR=/run/user/1000
    CONFIG=$(openclaw config get plugins.entries.openclaw-mcp-adapter.config 2>&1) || {
        if echo "$CONFIG" | grep -qi "not set\|not found\|does not exist\|undefined"; then
            CONFIG='{}'
        else
            echo "ERROR reading plugin config: $CONFIG" >&2
            exit 1
        fi
    }
    QMD_COUNT=$(echo "$CONFIG" | jq '[.servers[]? | select(.name | startswith("qmd"))] | length')
    echo "$QMD_COUNT"
  args:
    executable: /bin/bash
  register: qmd_server_count
  changed_when: false

- name: Check current memorySearch state
  ansible.builtin.shell: |
    export XDG_RUNTIME_DIR=/run/user/1000
    RESULT=$(openclaw config get agents.defaults.memorySearch.enabled 2>&1) || true
    if echo "$RESULT" | grep -q "not found\|not set\|undefined"; then
      echo "unset"
    else
      echo "$RESULT"
    fi
  args:
    executable: /bin/bash
  register: memory_search_state
  changed_when: false
  when: (qmd_server_count.stdout | int) > 0

- name: Disable built-in memorySearch (replaced by qmd)
  ansible.builtin.shell: |
    export XDG_RUNTIME_DIR=/run/user/1000
    openclaw config set agents.defaults.memorySearch.enabled false
  args:
    executable: /bin/bash
  when:
    - (qmd_server_count.stdout | int) > 0
    - memory_search_state.stdout != "false"
  notify: restart openclaw-gateway
