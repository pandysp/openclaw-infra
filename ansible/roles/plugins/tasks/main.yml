---
# Install and configure the mcp-adapter plugin with GitHub and Codex MCP servers.
# Skipped entirely if openclaw_mcp_adapter is not defined (in playbook.yml).
# Force reinstall with: -e force_plugin_reinstall=true

- name: Check if mcp-adapter plugin directory exists
  ansible.builtin.stat:
    path: /home/ubuntu/.openclaw/extensions/openclaw-mcp-adapter/index.ts
  register: plugin_dir

- name: Install mcp-adapter plugin
  when: not plugin_dir.stat.exists or force_plugin_reinstall | bool
  block:
    - name: Remove stale plugin config entry before reinstall
      ansible.builtin.shell: |
        set -euo pipefail
        python3 -c "
        import json, os, tempfile
        config_path = '/home/ubuntu/.openclaw/openclaw.json'
        with open(config_path) as f:
            cfg = json.load(f)
        if 'openclaw-mcp-adapter' in cfg.get('plugins', {}).get('entries', {}):
            del cfg['plugins']['entries']['openclaw-mcp-adapter']
            fd, tmp = tempfile.mkstemp(dir=os.path.dirname(config_path), suffix='.tmp')
            try:
                with os.fdopen(fd, 'w') as f:
                    json.dump(cfg, f, indent=2)
                os.rename(tmp, config_path)
            except:
                os.unlink(tmp)
                raise
        "
      args:
        executable: /bin/bash
      when: force_plugin_reinstall | bool
      changed_when: false

    - name: Remove existing plugin directory (reinstall)
      ansible.builtin.file:
        path: /home/ubuntu/.openclaw/extensions/openclaw-mcp-adapter
        state: absent
      when: force_plugin_reinstall | bool

    - name: Clone mcp-adapter fork
      ansible.builtin.git:
        repo: "{{ openclaw_mcp_adapter.source }}"
        dest: /tmp/mcp-adapter
        version: main
        depth: 1

    - name: Install plugin from local clone
      ansible.builtin.shell: |
        set -euo pipefail
        export XDG_RUNTIME_DIR=/run/user/1000
        openclaw plugins install /tmp/mcp-adapter
      args:
        executable: /bin/bash

  always:
    - name: Clean up plugin clone
      ansible.builtin.file:
        path: /tmp/mcp-adapter
        state: absent

- name: Ensure npm global prefix is configured
  ansible.builtin.shell: |
    set -euo pipefail
    PREFIX=$(npm config get prefix 2>/dev/null || echo "")
    if [ -z "$PREFIX" ] || [ "$PREFIX" = "/usr/local" ] || [ "$PREFIX" = "/usr" ]; then
        npm config set prefix "$HOME/.npm-global"
    fi
    npm config get prefix
  args:
    executable: /bin/bash
  register: npm_prefix
  changed_when: false

- name: Ensure npm global bin is in PATH profile
  ansible.builtin.lineinfile:
    path: /home/ubuntu/.profile
    line: 'export PATH="$HOME/.npm-global/bin:$PATH"'
    state: present

- name: Determine which npm packages to install
  ansible.builtin.set_fact:
    mcp_npm_packages: >-
      {{ openclaw_mcp_adapter.npm_packages
         | reject('equalto', '@openai/codex')
         | list
         + (['@openai/codex'] if (codex_auth_json | default('') | length > 0) else []) }}

- name: Install MCP server npm packages globally
  community.general.npm:
    name: "{{ item }}"
    global: true
    state: present
  environment:
    PATH: "{{ (npm_prefix.stdout_lines | last) | trim }}/bin:{{ ansible_env.PATH }}"
  loop: "{{ mcp_npm_packages }}"

- name: Resolve mcp-server-github binary path
  ansible.builtin.shell: |
    set -euo pipefail
    export PATH="{{ (npm_prefix.stdout_lines | last) | trim }}/bin:$PATH"
    BINARY=$(which mcp-server-github) || {
        echo "ERROR: mcp-server-github not found in PATH after npm install"
        echo "Expected at: {{ (npm_prefix.stdout_lines | last) | trim }}/bin/mcp-server-github"
        exit 1
    }
    echo "$BINARY"
  args:
    executable: /bin/bash
  register: github_mcp_binary
  changed_when: false

- name: Deploy Codex auth credentials
  when: codex_auth_json | default('') | length > 0
  block:
    - name: Ensure .codex directory exists
      ansible.builtin.file:
        path: /home/ubuntu/.codex
        state: directory
        mode: "0700"

    - name: Write Codex auth.json
      ansible.builtin.copy:
        content: "{{ codex_auth_json }}"
        dest: /home/ubuntu/.codex/auth.json
        mode: "0600"
      no_log: true

- name: Verify codex auth.json is a regular file (not a directory)
  ansible.builtin.stat:
    path: /home/ubuntu/.codex/auth.json
  register: codex_auth_stat
  when: codex_auth_json | default('') | length > 0

- name: Fail if auth.json is a directory (Docker -v corruption)
  ansible.builtin.assert:
    that: codex_auth_stat.stat.isreg
    fail_msg: >-
      /home/ubuntu/.codex/auth.json is a directory, not a file.
      This is likely caused by a previous Docker bind mount when the file
      did not exist. Remove it with: rm -rf /home/ubuntu/.codex/auth.json
  when: codex_auth_json | default('') | length > 0 and codex_auth_stat.stat.exists

- name: Ensure agent workspace directories exist for Codex containers
  ansible.builtin.file:
    path: "{{ item.cwd }}"
    state: directory
    mode: "0755"
  loop: "{{ openclaw_mcp_adapter.servers | selectattr('type', 'equalto', 'codex') | list }}"
  loop_control:
    label: "{{ item.name }}"
  when: codex_auth_json | default('') | length > 0

- name: Build Codex MCP Docker image
  when: codex_auth_json | default('') | length > 0
  block:
    - name: Check if Codex MCP image exists
      ansible.builtin.command: "docker image inspect \"{{ openclaw_mcp_adapter.codex_docker_image }}\""
      register: codex_image_check
      changed_when: false
      failed_when: false

    - name: Create Codex MCP build directory
      ansible.builtin.file:
        path: /home/ubuntu/.openclaw/codex-mcp-build
        state: directory
        mode: "0755"

    - name: Template Codex MCP Dockerfile
      ansible.builtin.template:
        src: Dockerfile.codex-mcp.j2
        dest: /home/ubuntu/.openclaw/codex-mcp-build/Dockerfile
        mode: "0644"
      register: codex_dockerfile_changed

    - name: Build Codex MCP Docker image
      ansible.builtin.shell: |
        set -euo pipefail
        docker build -t "{{ openclaw_mcp_adapter.codex_docker_image }}" /home/ubuntu/.openclaw/codex-mcp-build/
      args:
        executable: /bin/bash
      when: codex_image_check.rc != 0 or codex_dockerfile_changed.changed or (force_codex_rebuild | bool)
      register: codex_image_build

    - name: Verify Codex MCP image was built
      ansible.builtin.command: "docker image inspect \"{{ openclaw_mcp_adapter.codex_docker_image }}\""
      changed_when: false

    - name: Smoke test Codex MCP image
      ansible.builtin.shell: |
        docker run --rm "{{ openclaw_mcp_adapter.codex_docker_image }}" codex --version
      args:
        executable: /bin/bash
      changed_when: false
      when: codex_image_build is changed

    - name: Remove Codex MCP containers after image rebuild
      ansible.builtin.shell: |
        set -euo pipefail
        containers=$(docker ps -aq --filter "label=openclaw-role=codex-mcp")
        if [ -n "$containers" ]; then
          echo "$containers" | xargs docker rm -f
        fi
      args:
        executable: /bin/bash
      register: codex_container_removal
      changed_when: codex_container_removal.stdout | length > 0
      when: codex_image_build is changed

    - name: Verify no Codex MCP containers remain after cleanup
      ansible.builtin.shell: |
        set -euo pipefail
        count=$(docker ps -aq --filter "label=openclaw-role=codex-mcp" | wc -l)
        if [ "$count" -ne 0 ]; then
          echo "ERROR: $count Codex MCP containers still present after removal"
          docker ps -a --filter "label=openclaw-role=codex-mcp" --format '{{ '{{' }}.ID{{ '}}' }} {{ '{{' }}.Image{{ '}}' }} {{ '{{' }}.Status{{ '}}' }}'
          exit 1
        fi
      args:
        executable: /bin/bash
      changed_when: false
      when: codex_container_removal is changed

    - name: Restart gateway to pick up new Codex MCP image
      ansible.builtin.systemd:
        name: openclaw-gateway
        state: restarted
        scope: user
      become: false
      environment:
        XDG_RUNTIME_DIR: /run/user/1000
      when: codex_image_build is changed

    - name: Wait for gateway to be healthy after Codex image rebuild
      ansible.builtin.command: openclaw health
      register: codex_health_check
      retries: 5
      delay: 3
      until: codex_health_check.rc == 0
      changed_when: false
      when: codex_image_build is changed

  rescue:
    - name: Capture gateway logs for diagnosis
      ansible.builtin.shell: |
        export XDG_RUNTIME_DIR=/run/user/1000
        journalctl --user -u openclaw-gateway --since "2 minutes ago" --no-pager | tail -50
      args:
        executable: /bin/bash
      register: gateway_crash_logs
      failed_when: false

    - name: Report gateway failure with diagnostic context
      ansible.builtin.fail:
        msg: |
          Gateway failed health check after Codex MCP image rebuild.
          Recent gateway logs:
          {{ gateway_crash_logs.stdout | default('(no logs captured)') }}
          Manual recovery: ssh ubuntu@<host> 'XDG_RUNTIME_DIR=/run/user/1000 journalctl --user -u openclaw-gateway -n 100'

- name: Validate token variable names are defined
  ansible.builtin.assert:
    that:
      - item.token_var in hostvars[inventory_hostname]
    fail_msg: >-
      Server '{{ item.name }}' references token_var '{{ item.token_var }}'
      which is not a defined variable. Check group_vars/all.yml and provision.sh.
    quiet: true
  loop: "{{ openclaw_mcp_adapter.servers | selectattr('token_var', 'defined') | list }}"
  loop_control:
    label: "{{ item.name }}"

- name: Write server tokens to temp files (de-duplicated by token_var)
  ansible.builtin.copy:
    content: "{{ lookup('vars', item, default='') }}"
    dest: "/tmp/ansible-mcp-token-{{ item }}"
    mode: "0600"
  no_log: true
  loop: "{{ openclaw_mcp_adapter.servers | selectattr('token_var', 'defined') | map(attribute='token_var') | unique | list }}"

- name: Build and write plugin config JSON
  ansible.builtin.shell: |
    set -euo pipefail
    GITHUB_BINARY="{{ github_mcp_binary.stdout | trim }}"
    TOOL_PREFIX='{{ openclaw_mcp_adapter.tool_prefix | to_json }}'
    CODEX_SANDBOX="{{ openclaw_mcp_adapter.codex_sandbox | default('workspace-write') }}"
    CODEX_APPROVAL="{{ openclaw_mcp_adapter.codex_approval | default('never') }}"
    # Build servers array
    SERVERS="[]"

    # GitHub servers — only include when token is non-empty
    {% for srv in openclaw_mcp_adapter.servers | selectattr('type', 'equalto', 'github') %}
    TOKEN_FILE="/tmp/ansible-mcp-token-{{ srv.token_var }}"
    if [ ! -f "$TOKEN_FILE" ]; then
        echo "ERROR: Token file $TOKEN_FILE is missing — write task may have failed"
        exit 1
    fi
    TOKEN=$(cat "$TOKEN_FILE")
    if [ -n "$TOKEN" ]; then
        SERVERS=$(echo "$SERVERS" | jq --arg name "{{ srv.name }}" \
            --arg cmd "$GITHUB_BINARY" \
            --arg token "$TOKEN" \
            '. + [{name: $name, transport: "stdio", command: $cmd, env: {GITHUB_PERSONAL_ACCESS_TOKEN: $token}}]')
    fi
    {% endfor %}

    # Codex servers — containerized with docker run -i (stdio piped through Docker)
    # Security: containers only see the agent's workspace + auth.json (read-only).
    # No access to gateway config, other agents' workspaces, SSH keys, etc.
    CODEX_IMAGE="{{ openclaw_mcp_adapter.codex_docker_image }}"
    CODEX_MEM="{{ openclaw_mcp_adapter.codex_memory_limit | default('2g') }}"
    if [ -f "/home/ubuntu/.codex/auth.json" ]; then
    {% for srv in openclaw_mcp_adapter.servers | selectattr('type', 'equalto', 'codex') %}
        DOCKER_ARGS=$(jq -n \
            --arg ws "{{ srv.cwd }}" \
            --arg img "$CODEX_IMAGE" \
            --arg agent "{{ srv.agent_id }}" \
            --arg mem "$CODEX_MEM" \
            --arg sandbox "$CODEX_SANDBOX" \
            --arg approval "$CODEX_APPROVAL" \
            '["run","--rm","-i","--init","--net=bridge",
              ("--memory=" + $mem),("--memory-swap=" + $mem),
              "--label","openclaw-role=codex-mcp",
              "--label",("openclaw-agent=" + $agent),
              "--mount",("type=bind,source=" + $ws + ",target=/workspace"),
              "--mount","type=bind,source=/home/ubuntu/.codex/auth.json,target=/home/node/.codex/auth.json,readonly",
              "-w","/workspace",
              $img,
              "codex","mcp-server","-c",("sandbox_mode=" + $sandbox),"-c",("approval_policy=" + $approval)]')
        SERVERS=$(echo "$SERVERS" | jq --arg name "{{ srv.name }}" --argjson args "$DOCKER_ARGS" \
            '. + [{name: $name, transport: "stdio", command: "docker", args: $args}]')
    {% endfor %}
    fi

    # Build final config
    CONFIG=$(jq -n --argjson prefix "$TOOL_PREFIX" --argjson servers "$SERVERS" \
        '{toolPrefix: $prefix, servers: $servers}')

    echo "$CONFIG" > /tmp/ansible-plugin-config
    chmod 600 /tmp/ansible-plugin-config
  args:
    executable: /bin/bash
  # no_log omitted intentionally — tokens are in temp files, not in this template.
  # Errors here (jq failures, missing files) must be visible for debugging.

- name: Configure mcp-adapter plugin
  block:
    - name: Set plugin config and enable
      ansible.builtin.shell: |
        set -euo pipefail
        export XDG_RUNTIME_DIR=/run/user/1000
        CONFIG=$(cat /tmp/ansible-plugin-config)
        openclaw config set plugins.entries.openclaw-mcp-adapter.config --json "$CONFIG"
        openclaw config set plugins.entries.openclaw-mcp-adapter.enabled true
      args:
        executable: /bin/bash
      no_log: true
      notify: restart openclaw-gateway

    - name: Verify plugin config was applied
      ansible.builtin.shell: |
        set -euo pipefail
        export XDG_RUNTIME_DIR=/run/user/1000
        ENABLED=$(openclaw config get plugins.entries.openclaw-mcp-adapter.enabled 2>&1) || {
            echo "ERROR: Failed to read plugin enabled state after config set"
            exit 1
        }
        if [ "$ENABLED" != "true" ]; then
            echo "ERROR: Plugin enabled state is '$ENABLED', expected 'true'"
            exit 1
        fi
      args:
        executable: /bin/bash
      changed_when: false

  always:
    - name: Clean up plugin config temp file
      ansible.builtin.file:
        path: /tmp/ansible-plugin-config
        state: absent

    - name: Clean up token temp files
      ansible.builtin.file:
        path: "/tmp/ansible-mcp-token-{{ item }}"
        state: absent
      loop: "{{ openclaw_mcp_adapter.servers | selectattr('token_var', 'defined') | map(attribute='token_var') | unique | list }}"

- name: Flush handlers to restart gateway before verification
  ansible.builtin.meta: flush_handlers

- name: Wait for gateway to stabilize after plugin config
  ansible.builtin.pause:
    seconds: 5

- name: Verify mcp-adapter plugin is loaded
  ansible.builtin.shell: |
    export XDG_RUNTIME_DIR=/run/user/1000
    openclaw plugins list --json | jq -e '.plugins[] | select(.id == "openclaw-mcp-adapter")'
  args:
    executable: /bin/bash
  changed_when: false

- name: Check gateway logs for mcp-adapter errors
  ansible.builtin.shell: |
    set -euo pipefail
    export XDG_RUNTIME_DIR=/run/user/1000
    LOGS=$(journalctl --user -u openclaw-gateway --since "30 seconds ago" --no-pager)
    if echo "$LOGS" | grep -qi "mcp.*error\|error.*mcp\|failed.*mcp-adapter\|docker.*error\|container.*failed\|image.*not found"; then
        echo "ERROR: Gateway logs contain MCP adapter errors:"
        echo "$LOGS" | grep -i "mcp"
        exit 1
    fi
    echo "$LOGS" | grep -i "mcp" || echo "No mcp-adapter log entries yet (normal for lazy-loaded plugins)"
  args:
    executable: /bin/bash
  register: mcp_logs
  changed_when: false

- name: Show mcp-adapter log status
  ansible.builtin.debug:
    var: mcp_logs.stdout_lines

# --- Per-agent MCP tool scoping ---
# Each agent denies all MCP server tool prefixes except its own.
# Glob patterns use server name + "_*" suffix (e.g. "github-manon_*", "codex-tl_*").
# Safe because toolPrefix uses "_" while server names use "-" as separator,
# so "github_*" cannot match "github-manon_*". Server names must never contain "_".
# e.g. agent "main" gets deny: ["github-manon_*", "github-tl_*", "codex-manon_*", "codex-tl_*"]

- name: Validate server agent_id values match defined agents
  ansible.builtin.assert:
    that:
      - item.agent_id in (openclaw_agents | map(attribute='id') | list)
    fail_msg: >-
      Server '{{ item.name }}' has agent_id '{{ item.agent_id }}'
      which does not match any agent in openclaw_agents.
      Valid agent IDs: {{ openclaw_agents | map(attribute='id') | list }}
    quiet: true
  loop: "{{ openclaw_mcp_adapter.servers }}"
  loop_control:
    label: "{{ item.name }}"

- name: Get agent list for index resolution
  ansible.builtin.shell: |
    export XDG_RUNTIME_DIR=/run/user/1000
    openclaw agents list --json
  args:
    executable: /bin/bash
  register: agents_list_json
  changed_when: false

- name: Set per-agent tool deny rules for MCP tools
  ansible.builtin.shell: |
    set -euo pipefail
    export XDG_RUNTIME_DIR=/run/user/1000
    AGENTS_JSON='{{ agents_list_json.stdout }}'
    AGENT_INDEX=$(echo "$AGENTS_JSON" | jq -r 'to_entries[] | select(.value.id == "{{ item.id }}") | .key')
    if [ -z "$AGENT_INDEX" ]; then
        echo "SKIP: Agent '{{ item.id }}' not found in agents list"
        exit 0
    fi
    CURRENT=$(openclaw config get "agents.list.${AGENT_INDEX}.tools.deny" 2>/dev/null || echo "[]")
    DESIRED='{{ deny_list | to_json }}'
    if [ "$CURRENT" = "$DESIRED" ]; then
        echo "UNCHANGED"
    else
        openclaw config set "agents.list.${AGENT_INDEX}.tools.deny" --json "$DESIRED"
        echo "CHANGED"
    fi
  args:
    executable: /bin/bash
  vars:
    deny_list: >-
      {{ openclaw_mcp_adapter.servers
         | rejectattr('agent_id', 'equalto', item.id)
         | map(attribute='name')
         | map('regex_replace', '$', '_*')
         | list }}
  loop: "{{ openclaw_agents }}"
  loop_control:
    label: "{{ item.id }}"
  register: deny_result
  changed_when: "'CHANGED' in deny_result.stdout"
  notify: restart openclaw-gateway
