---
- name: Check if OpenClaw config exists
  ansible.builtin.stat:
    path: /home/ubuntu/.openclaw/openclaw.json
  register: openclaw_config

- name: Validate provider configuration for onboarding
  ansible.builtin.assert:
    that:
      - provider is defined
      - provider in ['claude', 'kimi']
      - token_provider is defined
      - auth_choice is defined
      - api_token is defined
    fail_msg: >-
      Missing or invalid provider configuration.
      provider={{ provider | default('UNDEFINED') }},
      token_provider={{ token_provider | default('UNDEFINED') }},
      auth_choice={{ auth_choice | default('UNDEFINED') }}.
      Ensure provision.sh passes all provider variables.

- name: Compute onboard token arguments
  ansible.builtin.set_fact:
    onboard_token_args: >-
      {{ '--kimi-code-api-key "$API_TOKEN"'
         if provider == 'kimi'
         else '--token "$API_TOKEN" --token-provider ' + token_provider }}

- name: Write setup token to temp file
  ansible.builtin.copy:
    content: "{{ api_token }}"
    dest: /tmp/ansible-setup-token
    mode: "0600"
  no_log: true
  when: not openclaw_config.stat.exists

- name: Run OpenClaw onboarding
  ansible.builtin.shell: |
    set -euo pipefail
    export XDG_RUNTIME_DIR=/run/user/1000
    API_TOKEN=$(cat /tmp/ansible-setup-token)
    ONBOARD_OUTPUT=$(openclaw onboard --non-interactive --accept-risk \
        --mode local \
        --auth-choice "{{ auth_choice }}" \
        {{ onboard_token_args }} \
        --gateway-port 18789 \
        --gateway-bind loopback \
        --skip-daemon \
        --skip-skills 2>&1) || ONBOARD_EXIT=$?
    if [ -n "${ONBOARD_EXIT:-}" ] && [ "$ONBOARD_EXIT" -ne 0 ]; then
        if echo "$ONBOARD_OUTPUT" | grep -q "gateway closed"; then
            echo "Note: Ignoring expected 'gateway closed' error"
        else
            echo "ERROR: OpenClaw onboarding failed with exit code $ONBOARD_EXIT"
            echo "$ONBOARD_OUTPUT"
            exit 1
        fi
    fi
    if [ ! -f ~/.openclaw/openclaw.json ]; then
        echo "ERROR: Onboarding failed - config file not created"
        echo "$ONBOARD_OUTPUT"
        exit 1
    fi
  args:
    executable: /bin/bash
  no_log: true
  when: not openclaw_config.stat.exists

- name: Restrict .openclaw directory permissions
  ansible.builtin.file:
    path: /home/ubuntu/.openclaw
    mode: "0700"

- name: Clean up setup token
  ansible.builtin.file:
    path: /tmp/ansible-setup-token
    state: absent
  when: not openclaw_config.stat.exists
