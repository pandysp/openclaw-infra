---
- name: Check installed bd version
  ansible.builtin.shell: |
    if [ -x /usr/local/bin/bd ]; then
      /usr/local/bin/bd --version 2>/dev/null || echo ""
    else
      echo ""
    fi
  args:
    executable: /bin/bash
  register: beads_installed_version
  changed_when: false

- name: Extract installed beads semver
  ansible.builtin.set_fact:
    beads_installed_semver: "{{ beads_installed_version.stdout | regex_search('[0-9]+\\.[0-9]+\\.[0-9]+') | default('') }}"

- name: Install or upgrade beads (bd) from GitHub release
  ansible.builtin.shell: |
    set -euo pipefail
    TMPDIR=$(mktemp -d)
    trap 'rm -rf "$TMPDIR"' EXIT
    curl -fsSL "https://github.com/steveyegge/beads/releases/download/v{{ beads_version }}/beads_{{ beads_version }}_linux_amd64.tar.gz" \
      | tar -xz -C "$TMPDIR" bd
    install -m 0755 "$TMPDIR/bd" /usr/local/bin/bd
    echo "INSTALLED"
  args:
    executable: /bin/bash
  become: true
  register: beads_install
  changed_when: "'INSTALLED' in beads_install.stdout"
  when: beads_installed_semver == "" or beads_installed_semver != beads_version

- name: Remove manually installed bd that shadows /usr/local/bin/bd
  ansible.builtin.file:
    path: /home/ubuntu/.local/bin/bd
    state: absent
  # ~/.local/bin typically precedes /usr/local/bin in PATH; a manually installed
  # binary here (e.g. v0.56.1) would shadow the Ansible-managed version and cause
  # format mismatches between the host and sandbox containers.

- name: Show beads status
  ansible.builtin.debug:
    msg: "Beads {{ beads_version }} ready (installed: {{ beads_installed_semver | default('fresh') }})"
