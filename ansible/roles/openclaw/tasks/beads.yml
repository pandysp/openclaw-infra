---
# Check via full path since /home/ubuntu/.local/bin may not be in PATH yet
- name: Check installed bd version
  ansible.builtin.shell: |
    for bin in /home/ubuntu/.local/bin/bd /usr/local/bin/bd; do
      if [ -x "$bin" ]; then "$bin" --version 2>/dev/null; exit 0; fi
    done
    echo ""
  args:
    executable: /bin/bash
  register: beads_installed_version
  changed_when: false

- name: Install or upgrade beads (bd)
  ansible.builtin.shell: |
    curl -sSL https://raw.githubusercontent.com/steveyegge/beads/main/scripts/install.sh | bash
    echo "INSTALLED"
  args:
    executable: /bin/bash
  register: beads_install
  # Install script exits rc=1 if ~/.local/bin not in PATH â€” that's fine, symlink handles it
  failed_when: "'bd installed to' not in beads_install.stdout"
  changed_when: "'INSTALLED' in beads_install.stdout"
  when: beads_installed_version.stdout | trim == ""

- name: Symlink bd to /usr/local/bin
  become: true
  ansible.builtin.file:
    src: /home/ubuntu/.local/bin/bd
    dest: /usr/local/bin/bd
    state: link
    force: true

- name: Get installed bd version
  ansible.builtin.command: /usr/local/bin/bd --version
  register: beads_final_version
  changed_when: false

- name: Update beads_version fact to match installed version
  ansible.builtin.set_fact:
    beads_version: "{{ beads_final_version.stdout | regex_search('[0-9]+\\.[0-9]+\\.[0-9]+') }}"

- name: Show beads status
  ansible.builtin.debug:
    msg: "Beads {{ beads_version }} ready"
