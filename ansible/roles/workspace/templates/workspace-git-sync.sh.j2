#!/bin/bash
set -euo pipefail
cd {{ item.workspace_dir }}

# Ensure branch is named 'main' regardless of how it was initialized
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "")
if [ "$CURRENT_BRANCH" != "main" ] && [ -n "$CURRENT_BRANCH" ]; then
    git branch -m "$CURRENT_BRANCH" main
fi

# Commit any local changes first (so they're never lost)
git add -A
if ! git diff --cached --quiet; then
    git commit -m "Auto-sync: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
fi

# Reconcile with remote before pushing (local workspace takes precedence on conflict)
git fetch origin main
if ! git rebase -X ours origin/main 2>/dev/null; then
    echo "Rebase failed, falling back to merge" >&2
    git rebase --abort 2>/dev/null || true
    if ! git merge -X ours origin/main --no-edit 2>/dev/null; then
        git merge --abort 2>/dev/null || true
        echo "WARNING: Cannot reconcile, forcing local state for {{ item.agent_id }}" >&2
        git push --force-with-lease origin main
    fi
fi

# Push if we have commits ahead of remote
if [ "$(git rev-list --count origin/main..HEAD)" -gt 0 ]; then
    git push origin main
fi
