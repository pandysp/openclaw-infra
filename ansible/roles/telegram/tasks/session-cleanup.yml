---
# Insurance: after bindings are set, verify that each group agent's main session
# has the correct delivery target. If not, delete the stale session so the next
# heartbeat creates a fresh one with the correct target.
# Related to upstream bug #18573. See docs/HEARTBEAT-GROUP-DELIVERY-FIX.md.

- name: Write agent config for session check
  ansible.builtin.copy:
    content: "{{ openclaw_agents | to_json }}"
    dest: /tmp/ansible-agents-session-check.json
    mode: "0600"
  changed_when: false

- name: Check and fix group agent session delivery targets
  ansible.builtin.shell: |
    set -euo pipefail
    python3 << 'PYEOF'
    import json, os, sys

    with open("/tmp/ansible-agents-session-check.json") as f:
        agents = json.load(f)

    changes = []

    for agent in agents:
        agent_id = agent["id"]
        deliver_to = agent.get("deliver_to", "")
        deliver_type = agent.get("deliver_type", "dm")

        if deliver_type != "group" or not deliver_to:
            continue

        sessions_path = "/home/ubuntu/.openclaw/agents/%s/sessions/sessions.json" % agent_id
        session_key = "agent:%s:main" % agent_id

        if not os.path.exists(sessions_path):
            continue

        with open(sessions_path) as f:
            store = json.load(f)

        entry = store.get(session_key)
        if not entry:
            continue

        current_to = entry.get("deliveryContext", {}).get("to", "")
        deliver_channel = agent.get("deliver_channel", "telegram")
        normalized_current = current_to.replace(deliver_channel + ":", "")
        normalized_expected = str(deliver_to)

        if normalized_current == normalized_expected:
            print("OK: %s -> %s" % (agent_id, current_to))
            continue

        session_id = entry.get("sessionId", "")
        del store[session_key]
        with open(sessions_path, "w") as f:
            json.dump(store, f, indent=2)

        jsonl_path = "/home/ubuntu/.openclaw/agents/%s/sessions/%s.jsonl" % (agent_id, session_id)
        if os.path.exists(jsonl_path):
            os.remove(jsonl_path)

        changes.append("FIXED: %s was %s, expected %s" % (agent_id, current_to, deliver_to))
        print("FIXED: %s session had deliveryContext.to=%s, expected %s -- removed stale session" % (agent_id, current_to, deliver_to))

    if not changes:
        print("OK: all group agent sessions have correct delivery targets")
    PYEOF
  args:
    executable: /bin/bash
  register: session_cleanup_result
  changed_when: "'FIXED' in session_cleanup_result.stdout"
  notify: restart openclaw-gateway

- name: Clean up session check temp file
  ansible.builtin.file:
    path: /tmp/ansible-agents-session-check.json
    state: absent
  changed_when: false
