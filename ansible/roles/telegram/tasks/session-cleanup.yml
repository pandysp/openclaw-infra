---
# Insurance: after bindings are set, verify that each group agent's main session
# has the correct delivery target. If not, delete the stale session so the next
# heartbeat creates a fresh one with the correct target.
# Related to upstream bug #18573. See docs/HEARTBEAT-GROUP-DELIVERY-FIX.md.

- name: Check and fix group agent session delivery targets
  ansible.builtin.shell: |
    set -euo pipefail
    python3 << 'PYEOF'
    import json, os, sys

    agents = {{ openclaw_agents | to_json }}
    changes = []

    for agent in agents:
        agent_id = agent["id"]
        deliver_to = agent.get("deliver_to", "")
        deliver_type = agent.get("deliver_type", "dm")

        # Only check group agents — DM agents don't have this bug
        if deliver_type != "group" or not deliver_to:
            continue

        sessions_path = f"/home/ubuntu/.openclaw/agents/{agent_id}/sessions/sessions.json"
        session_key = f"agent:{agent_id}:main"

        if not os.path.exists(sessions_path):
            continue

        with open(sessions_path) as f:
            store = json.load(f)

        entry = store.get(session_key)
        if not entry:
            continue

        current_to = entry.get("deliveryContext", {}).get("to", "")
        # Normalize: strip "telegram:" prefix if present
        normalized_current = current_to.replace("telegram:", "")
        normalized_expected = str(deliver_to)

        if normalized_current == normalized_expected:
            print(f"OK: {agent_id} → {current_to}")
            continue

        # Stale session — remove it
        session_id = entry.get("sessionId", "")
        del store[session_key]
        with open(sessions_path, "w") as f:
            json.dump(store, f, indent=2)

        # Remove JSONL file
        jsonl_path = f"/home/ubuntu/.openclaw/agents/{agent_id}/sessions/{session_id}.jsonl"
        if os.path.exists(jsonl_path):
            os.remove(jsonl_path)

        changes.append(f"FIXED: {agent_id} was {current_to}, expected {deliver_to}")
        print(f"FIXED: {agent_id} session had deliveryContext.to={current_to}, expected {deliver_to} — removed stale session")

    if not changes:
        print("OK: all group agent sessions have correct delivery targets")
    PYEOF
  args:
    executable: /bin/bash
  register: session_cleanup_result
  changed_when: "'FIXED' in session_cleanup_result.stdout"
  notify: restart openclaw-gateway
