---
- name: Provision OpenClaw gateway
  hosts: openclaw
  gather_facts: true

  pre_tasks:
    - name: Wait for SSH connectivity
      wait_for_connection:
        timeout: 300
        delay: 10

  roles:
    - { role: system,    tags: [system],    become: true }
    - { role: docker,    tags: [docker],    become: true }
    - { role: ufw,       tags: [ufw],       become: true }
    - { role: openclaw,  tags: [openclaw] }
    - { role: config,    tags: [config] }
    - { role: plugins,   tags: [plugins],   when: openclaw_mcp_adapter is defined }
    - { role: agents,    tags: [agents],    when: telegram_bot_token is defined and telegram_bot_token | length > 0 }
    # telegram must run immediately after agents â€” if sandbox runs in between,
    # agents exist without bindings and incoming messages get misrouted.
    - { role: telegram,  tags: [telegram],  when: telegram_bot_token is defined and telegram_bot_token | length > 0 }
    - { role: sandbox,   tags: [sandbox] }
    - role: workspace
      tags: [workspace]
      when: openclaw_workspaces | selectattr('repo_url', 'ne', '') | selectattr('deploy_key', 'ne', '') | list | length > 0

  post_tasks:
    - name: Ensure openclaw-gateway is started and enabled
      ansible.builtin.systemd:
        name: openclaw-gateway
        state: started
        enabled: true
        scope: user
      environment:
        XDG_RUNTIME_DIR: "/run/user/1000"
      tags: [docker, config, openclaw, sandbox, agents, plugins]

    - name: Wait for gateway to stabilize
      ansible.builtin.pause:
        seconds: 5
      tags: [docker, config, openclaw, sandbox, agents, plugins]

    - name: Verify gateway is active
      ansible.builtin.command: systemctl --user is-active openclaw-gateway
      environment:
        XDG_RUNTIME_DIR: "/run/user/1000"
      changed_when: false
      tags: [docker, config, openclaw, sandbox, agents, plugins]
