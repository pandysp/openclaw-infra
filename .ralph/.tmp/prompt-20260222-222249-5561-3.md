# Build

You are an autonomous coding agent. Your task is to complete the work for exactly one story and record the outcome.

## Paths
- PRD: /Users/andreasspannagel/projects/openclaw-infra/.agents/tasks/prd-review-action-plan.json
- AGENTS (optional): /Users/andreasspannagel/projects/openclaw-infra/AGENTS.md
- Progress Log: /Users/andreasspannagel/projects/openclaw-infra/.ralph/progress.md
- Guardrails: /Users/andreasspannagel/projects/openclaw-infra/.ralph/guardrails.md
- Guardrails Reference: /Users/andreasspannagel/Library/pnpm/global/5/.pnpm/@iannuttall+ralph@0.1.3/node_modules/@iannuttall/ralph/.agents/ralph/references/GUARDRAILS.md
- Context Reference: /Users/andreasspannagel/Library/pnpm/global/5/.pnpm/@iannuttall+ralph@0.1.3/node_modules/@iannuttall/ralph/.agents/ralph/references/CONTEXT_ENGINEERING.md
- Errors Log: /Users/andreasspannagel/projects/openclaw-infra/.ralph/errors.log
- Activity Log: /Users/andreasspannagel/projects/openclaw-infra/.ralph/activity.log
- Activity Logger: /Users/andreasspannagel/projects/openclaw-infra/ralph log
- No-commit: false
- Repo Root: /Users/andreasspannagel/projects/openclaw-infra
- Run ID: 20260222-222249-5561
- Iteration: 3
- Run Log: /Users/andreasspannagel/projects/openclaw-infra/.ralph/runs/run-20260222-222249-5561-iter-3.log
- Run Summary: /Users/andreasspannagel/projects/openclaw-infra/.ralph/runs/run-20260222-222249-5561-iter-3.md

## Global Quality Gates (apply to every story)
- ./scripts/provision.sh --check --diff
- ./scripts/verify.sh
- Successful deployment via ./scripts/provision.sh

## Selected Story (Do not change scope)
ID: US-002
Title: Fix shell injection via unescaped JSON and jq in Ansible tasks

Story details:
### US-002: Fix shell injection via unescaped JSON and jq in Ansible tasks
Status: in_progress
Depends on: US-001

Description:
As an operator, I want Ansible shell tasks to safely handle JSON output and agent IDs so that unexpected characters in command output or config values cannot break shell scripts or jq filters.

Acceptance Criteria:
- [ ] In ansible/roles/agents/tasks/main.yml: existing_agents.stdout is written to a temp file instead of inline single-quoted shell string. The temp file is cleaned up in an always block
- [ ] In ansible/roles/agents/tasks/main.yml: item.id is passed to jq using --arg instead of inline Jinja2 interpolation in the jq filter string
- [ ] Same fixes applied to ansible/roles/telegram/tasks/bindings.yml line 22 where JSON is interpolated into shell
- [ ] Same fixes applied to ansible/roles/agents/tasks/main.yml line 43 where JSON comparison uses inline interpolation
- [ ] Example: an agent ID containing a double quote character does not break the jq expression
- [ ] Negative case: JSON output containing single quotes does not break the shell script
- [ ] ./scripts/provision.sh --check --diff runs without errors


If the story details are empty or missing, STOP and report that the PRD story format could not be parsed.

## Rules (Non-Negotiable)
- Implement **only** the work required to complete the selected story.
- Complete all tasks associated with this story (and only this story).
- Do NOT ask the user questions.
- Do NOT change unrelated code.
- Do NOT assume something is unimplemented â€” confirm by reading code.
- Implement completely; no placeholders or stubs.
- If No-commit is true, do NOT commit or push changes.
- Do NOT edit the PRD JSON (status is handled by the loop).
- All changes made during the run must be committed (including updates to progress/logs).
 - Before committing, perform a final **security**, **performance**, and **regression** review of your changes.

## Your Task (Do this in order)
1. Read /Users/andreasspannagel/projects/openclaw-infra/.ralph/guardrails.md before any code changes.
2. Read /Users/andreasspannagel/projects/openclaw-infra/.ralph/errors.log for repeated failures to avoid.
3. Read /Users/andreasspannagel/projects/openclaw-infra/.agents/tasks/prd-review-action-plan.json for global context (do not edit).
4. Fully audit and read all necessary files to understand the task end-to-end before implementing. Do not assume missing functionality.
5. If /Users/andreasspannagel/projects/openclaw-infra/AGENTS.md exists, follow its build/test instructions.
6. Implement only the tasks that belong to US-002.
7. Run verification commands listed in the story, the global quality gates, and in /Users/andreasspannagel/projects/openclaw-infra/AGENTS.md (if required).
8. If the project has a build or dev workflow, run what applies:
   - Build step (e.g., `npm run build`) if defined.
   - Dev server (e.g., `npm run dev`, `wrangler dev`) if it is the normal validation path.
   - Confirm no runtime/build errors in the console.
9. Perform a brief audit before committing:
   - **Security:** check for obvious vulnerabilities or unsafe handling introduced by your changes.
   - **Performance:** check for avoidable regressions (extra queries, heavy loops, unnecessary re-renders).
   - **Regression:** verify existing behavior that could be impacted still works.
10. If No-commit is false, commit changes using the `$commit` skill.
    - Stage everything: `git add -A`
    - Confirm a clean working tree after commit: `git status --porcelain` should be empty.
    - After committing, capture the commit hash and subject using:
      `git show -s --format="%h %s" HEAD`.
11. Append a progress entry to /Users/andreasspannagel/projects/openclaw-infra/.ralph/progress.md with run/commit/test details (format below).
    If No-commit is true, skip committing and note it in the progress entry.

## Progress Entry Format (Append Only)
```
## [Date/Time] - US-002: Fix shell injection via unescaped JSON and jq in Ansible tasks
Thread: [codex exec session id if available, otherwise leave blank]
Run: 20260222-222249-5561 (iteration 3)
Run log: /Users/andreasspannagel/projects/openclaw-infra/.ralph/runs/run-20260222-222249-5561-iter-3.log
Run summary: /Users/andreasspannagel/projects/openclaw-infra/.ralph/runs/run-20260222-222249-5561-iter-3.md
- Guardrails reviewed: yes
- No-commit run: false
- Commit: <hash> <subject> (or `none` + reason)
- Post-commit status: `clean` or list remaining files
- Verification:
  - Command: <exact command> -> PASS/FAIL
  - Command: <exact command> -> PASS/FAIL
- Files changed:
  - <file path>
  - <file path>
- What was implemented
- **Learnings for future iterations:**
  - Patterns discovered
  - Gotchas encountered
  - Useful context
---
```

## Completion Signal
Only output the completion signal when the **selected story** is fully complete and verified.
When the selected story is complete, output:
<promise>COMPLETE</promise>

Otherwise, end normally without the signal.

## Additional Guardrails
- When authoring documentation, capture the why (tests + implementation intent).
- If you learn how to run/build/test the project, update /Users/andreasspannagel/projects/openclaw-infra/AGENTS.md briefly (operational only).
- Keep AGENTS operational only; progress notes belong in /Users/andreasspannagel/projects/openclaw-infra/.ralph/progress.md.
- If you hit repeated errors, log them in /Users/andreasspannagel/projects/openclaw-infra/.ralph/errors.log and add a Sign to /Users/andreasspannagel/projects/openclaw-infra/.ralph/guardrails.md using /Users/andreasspannagel/Library/pnpm/global/5/.pnpm/@iannuttall+ralph@0.1.3/node_modules/@iannuttall/ralph/.agents/ralph/references/GUARDRAILS.md as the template.

## Activity Logging (Required)
Log major actions to /Users/andreasspannagel/projects/openclaw-infra/.ralph/activity.log using the helper:
```
/Users/andreasspannagel/projects/openclaw-infra/ralph log "message"
```
Log at least:
- Start of work on the story
- After major code changes
- After tests/verification
- After updating progress log

## Browser Testing (Required for Frontend Stories)
If the selected story changes UI, you MUST verify it in the browser:
1. Load the `dev-browser` skill.
2. Navigate to the relevant page.
3. Verify the UI changes work as expected.
4. Take a screenshot if helpful for the progress log.

A frontend story is NOT complete until browser verification passes.
